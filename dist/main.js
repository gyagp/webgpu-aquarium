!function(e){var t={};function i(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,i),s.l=!0,s.exports}i.m=e,i.c=t,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)i.d(r,s,function(t){return e[t]}.bind(null,s));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=0)}([function(e,t,i){"use strict";function r(e,t){const i=[];for(let r=0;r<e;++r)i.push(t());return i}function s(e,t){if(!e){if(t=t||"Assertion failed","undefined"!=typeof Error)throw new Error(t);throw t}}i.r(t);class o{constructor(e,t,i){this._frame=e,this._op=t,this._count=i}get frame(){return this._frame}set frame(e){this._frame=e}get op(){return this._op}get count(){return this._count}}class a{constructor(e,t,i,r,s){if(this._stride=0,this._offset=0,this._size=0,this._usage=s?GPUBufferUsage.INDEX:GPUBufferUsage.VERTEX,this._totalComponents=t,r instanceof Float32Array){const t=r.BYTES_PER_ELEMENT;this._size=i*t;const s=t*r.length;this._buf=e.createBuffer(s,this._usage|GPUBufferUsage.COPY_DST),e.setBufferData(this._buf,0,s,r)}else if(r instanceof Uint16Array){const t=r.BYTES_PER_ELEMENT;if(this._size=i*t,this._totalComponents%2!=0){r=function(e,t){if(!e&&!t)throw"Please specify valid arguments for parameters a and b.";if(!t||0===t.length)return e;if(!e||0===e.length)return t;if(Object.prototype.toString.call(e)!==Object.prototype.toString.call(t))throw"The types of the two arguments passed for parameters a and b do not match.";let i=new e.constructor(e.length+t.length);return i.set(e),i.set(t,e.length),i}(r,new Uint16Array([0]))}const s=t*r.length;this._buf=e.createBuffer(s,this._usage|GPUBufferUsage.COPY_DST),e.setBufferData(this._buf,0,s,r)}}dispose(){this._buf=null}get buffer(){return this._buf}get totalComponents(){return this._totalComponents}get stride(){return this._stride}get offset(){return this._offset}get usageBit(){return this._usage}get dataSize(){return this._size}}class n extends class{constructor(e){this._head=0,this._tail=0,this._size=0,this._tail=e,this._size=e}dispose(){}get size(){return this._size}get availableSize(){return this._size-this._tail}reset(e){return!1}flush(){}destroy(){}allocate(e){return 0}}{constructor(e,t){super(t),this.bufferManager=null,this.bufferManager=e,this.reset(t)}set mappedData(e){this._bufferMappedResultBuffer=e[0],this._pixels=e[1]}push(e,t,i,r,s,o){return(s instanceof Uint16Array?new Uint16Array(this._pixels):new Float32Array(this._pixels)).set(s),e.copyBufferToBuffer(this._bufferMappedResultBuffer,i,t,r,o),!0}reset(e){if(e>this.size)return!1;this._head=0,this._tail=0;let[t,i]=this.bufferManager.context.createBufferMapped(GPUBufferUsage.MAP_WRITE|GPUBufferUsage.COPY_SRC,e);return this._bufferMappedResultBuffer=t,this._pixels=i,!0}static MapWriteCallback(e,t){s(null!==e,"Invalid data in MapWriteCallback function."),t.mappedData=e,t.bufferManager.mappedBufferList.push(t)}flush(){this._head=0,this._tail=0,this._bufferMappedResultBuffer.unmap()}destroy(){this._bufferMappedResultBuffer=null}reMap(){this._bufferMappedResultBuffer.mapWriteAsync().then(e=>{n.MapWriteCallback([this._bufferMappedResultBuffer,e],this)})}allocate(e){return this._tail+=e,s(this._tail<this._size,"Unable to allocate the requested memory size."),this._tail-e}}class h{constructor(){this.mappedBufferList=new Array,this._enqueuedBufferList=new Array,this._bufferPoolSize=h.BUFFER_POOL_MAX_SIZE}dispose(){this.destroyBufferPool()}get size(){return this._bufferPoolSize}resetBuffer(e,t){if(-1===this._find(e))return!1;const i=e.size;return!!e.reset(t)&&(this._usedSize=this._usedSize-i+t,!0)}destroyBuffer(e){const t=this._find(e);return-1!==t&&(this._usedSize-=e.size,e.destroy(),this._enqueuedBufferList.splice(t,1),!0)}_find(e){return this._enqueuedBufferList.length>0?this._enqueuedBufferList.indexOf(e):-1}destroyBufferPool(){}flush(){for(let e of this._enqueuedBufferList)e.flush()}allocate(e,t){return null}}h.BUFFER_POOL_MAX_SIZE=4096e5,h.BUFFER_MAX_COUNT=10,h.BUFFER_PER_ALLOCATE_SIZE=h.BUFFER_POOL_MAX_SIZE/h.BUFFER_MAX_COUNT;class u extends h{constructor(e,t){super(),this.context=null,this.context=e,this.sync=t,this.encoder=e.createCommandEncoder()}dispose(){this.encoder=null}allocate(e,t){let i=null,r=0;if(this.sync){if(this._usedSize+e>this._bufferPoolSize)return{buffer:i,offset:t};i=new n(this,e),this._enqueuedBufferList.push(i)}else{for(;this.mappedBufferList.length>0&&(i=this.mappedBufferList[0],i.availableSize<e);)this.mappedBufferList.shift(),i=null;if(null==i)if(this._count<h.BUFFER_MAX_COUNT)this._usedSize+=e,i=new n(this,h.BUFFER_PER_ALLOCATE_SIZE),this.mappedBufferList.push(i),this._count++;else{if(!(this.mappedBufferList.length+this._enqueuedBufferList.length<this._count))return null;for(;0===this.mappedBufferList.length;)this.context.waitABit();i=this.mappedBufferList[0],i.availableSize<e&&(this.mappedBufferList.shift(),i=null)}0!==this._enqueuedBufferList.length&&this._enqueuedBufferList[this._enqueuedBufferList.length-1]==i||this._enqueuedBufferList.push(i),r=i.allocate(e),t=r}return{buffer:i,offset:t}}flush(){this.mappedBufferList.length>0&&this._enqueuedBufferList[this._enqueuedBufferList.length-1]===this.mappedBufferList[0]&&this.mappedBufferList.shift();for(let e of this._enqueuedBufferList)e.flush();const e=this.encoder.finish();if(this.context.queue.submit([e]),this.sync){for(let e=0;e<this._enqueuedBufferList.length;++e){this._enqueuedBufferList[e].dispose()}this._usedSize=0}else for(let e=0;e<this._enqueuedBufferList.length;++e){this._enqueuedBufferList[e].reMap()}this._enqueuedBufferList.length=0,this.encoder=this.context.createCommandEncoder()}destroyBufferPool(){if(this.sync){for(let e of this._enqueuedBufferList)e.destroy();this._enqueuedBufferList.length=0}}}var f=function(e,t,i,r){return new(i||(i=Promise))((function(s,o){function a(e){try{h(r.next(e))}catch(e){o(e)}}function n(e){try{h(r.throw(e))}catch(e){o(e)}}function h(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,n)}h((r=r.apply(e,t||[])).next())}))};let l=void 0;class c{constructor(){this.worldPosition=r(c.kWorldPosition,()=>0),this.nextPosition=r(c.kNextPosition,()=>0)}static toArray(e){let t=[];for(let i=0;i<e.length;++i)t=t.concat(e[i].getAsArray());return t}getAsArray(){return this.worldPosition.concat(this.scale,this.nextPosition,this.time)}static offsetof(e){let t=0;switch(e){case"worldPosition":t=0;break;case"scale":t=c.kWorldPosition;break;case"nextPosition":t=c.kWorldPosition+1;break;case"time":t=c.kWorldPosition+1+c.kNextPosition}return 4*t}get data(){return new Float32Array(this.getAsArray())}static get byteSize(){return 4*(c.kWorldPosition+1+c.kNextPosition+1)}}c.kWorldPosition=3,c.kNextPosition=3;class d{constructor(){this.worldPosition=r(d.kWorldPosition,()=>0),this.nextPosition=r(d.kNextPosition,()=>0),this.padding=r(d.kPadding,()=>0)}getAsArray(){return this.worldPosition.concat(this.scale,this.nextPosition,this.time,this.padding)}get data(){return new Float32Array(this.getAsArray())}static get byteSize(){return 4*(c.kWorldPosition+1+c.kNextPosition+1+d.kPadding)}}d.kWorldPosition=3,d.kNextPosition=3,d.kPadding=56;class p{constructor(){this.uniforms=r(p.kUniforms,()=>0)}get fishLength(){return this.uniforms[0]}set fishLength(e){this.uniforms[0]=e}get fishWaveLength(){return this.uniforms[1]}set fishWaveLength(e){this.uniforms[1]=e}get fishBendAmount(){return this.uniforms[2]}set fishBendAmount(e){this.uniforms[2]=e}get data(){return new Float32Array(this.uniforms)}static get byteSize(){return 4*p.kUniforms}}p.kUniforms=3;class m{constructor(){this.uniforms=r(m.kUniforms,()=>0)}get fogPower(){return this.uniforms[0]}set fogPower(e){this.uniforms[0]=e}get fogMult(){return this.uniforms[1]}set fogMult(e){this.uniforms[1]=e}get fogOffset(){return this.uniforms[2]}set fogOffset(e){this.uniforms[2]=e}get padding(){return this.uniforms[3]}set padding(e){this.uniforms[3]=e}get fogColor(){return this.uniforms.slice(4)}set fogColor(e){this.uniforms[4]=e[0],this.uniforms[5]=e[1],this.uniforms[6]=e[2],this.uniforms[7]=e[3]}get data(){return new Float32Array(this.uniforms)}static get byteSize(){return 4*m.kUniforms}}m.kUniforms=8;class _{constructor(){this.uniforms=r(_.kUniforms,()=>0)}get eta(){return this.uniforms[0]}set eta(e){this.uniforms[0]=e}get tankColorFudge(){return this.uniforms[1]}set tankColorFudge(e){this.uniforms[1]=e}get refractionFudge(){return this.uniforms[2]}set refractionFudge(e){this.uniforms[2]=e}get padding(){return this.uniforms[3]}set padding(e){this.uniforms[3]=e}get data(){return new Float32Array(this.uniforms)}static get byteSize(){return 4*_.kUniforms}}_.kUniforms=4;class g{constructor(){this.uniforms=r(g.kUniforms,()=>0)}get shininess(){return this.uniforms[0]}set shininess(e){this.uniforms[0]=e}get specularFactor(){return this.uniforms[1]}set specularFactor(e){this.uniforms[1]=e}get data(){return new Float32Array(this.uniforms)}static get byteSize(){return 4*g.kUniforms}}g.kUniforms=2;class S{constructor(){this.lightColor=r(S.kLightColor,()=>0),this.specular=r(S.kSpecular,()=>0),this.ambient=r(S.kAmbient,()=>0)}getAsArray(){return this.lightColor.concat(this.specular,this.ambient)}get data(){return new Float32Array(this.getAsArray())}static get byteSize(){return 4*(S.kLightColor+S.kSpecular+S.kAmbient)}}S.kLightColor=4,S.kSpecular=4,S.kAmbient=4;class x{constructor(){this.lightWorldPos=r(x.kLightWorldPos,()=>0),this.padding=0,this.viewProjection=r(x.kViewProjection,()=>0),this.viewInverse=r(x.kViewInverse,()=>0)}getAsArray(){return this.lightWorldPos.concat(this.padding,this.viewProjection,this.viewInverse)}get data(){return new Float32Array(this.getAsArray())}static get byteSize(){return 4*(x.kLightWorldPos+1+x.kViewProjection+x.kViewInverse)}}x.kLightWorldPos=3,x.kViewProjection=16,x.kViewInverse=16;class b{constructor(){this.uniforms=r(20,()=>0)}get time(){return this.uniforms}set time(e){this.uniforms=e}get data(){return new Float32Array(this.uniforms)}get byteSize(){return 4*this.uniforms.length}}class B{constructor(){this.world=r(B.kWorld,()=>0),this.worldInverseTranspose=r(B.kWorldInverseTranspose,()=>0),this.worldViewProjection=r(B.kWorldViewProjection,()=>0)}getAsArray(){return this.world.concat(this.worldInverseTranspose,this.worldViewProjection)}get data(){return new Float32Array(this.getAsArray())}static get byteSize(){return 4*(B.kWorld+B.kWorldInverseTranspose+B.kWorldViewProjection)}clone(){const e=new B;return e.world=this.world.slice(),e.worldInverseTranspose=this.worldInverseTranspose.slice(),e.worldViewProjection=this.worldViewProjection.slice(),e}}B.kWorld=16,B.kWorldInverseTranspose=16,B.kWorldViewProjection=16;class A{constructor(){this.worldUniforms=r(20,()=>new B)}get data(){let e=[];for(let t=0;t<this.worldUniforms.length;++t)e=e.concat(this.worldUniforms[t].getAsArray());return new Float32Array(e)}get byteSize(){return B.byteSize*this.worldUniforms.length}}class P{constructor(e,t){this._colorAttachmentCount=0,this.cColorAttachments=r(P.kMaxColorAttachments,()=>({}));for(let e=0;e<P.kMaxColorAttachments;++e)this.cColorAttachments[e].attachment=void 0,this.cColorAttachments[e].storeOp="store",this.cColorAttachments[e].loadValue={r:0,g:0,b:0,a:0};this.cDepthStencilAttachmentInfo={depthLoadValue:1,depthStoreOp:"store",stencilLoadValue:0,stencilStoreOp:"store"},this._colorAttachmentCount=e.length;let i=0;for(let t of e)t&&(this.cColorAttachments[i].attachment=t),++i;this.colorAttachments=this.cColorAttachments,t?(this.cDepthStencilAttachmentInfo.attachment=t,this.depthStencilAttachment=this.cDepthStencilAttachmentInfo):this.depthStencilAttachment=void 0}set colorAttachmentCount(e){this._colorAttachmentCount=e,this.colorAttachments=this.cColorAttachments.slice(0,this._colorAttachmentCount)}}P.kMaxColorAttachments=4;class D{constructor(e){this._colorStateCount=0;this.primitiveTopology="triangle-list",this.sampleCount=1,this.vertexStage={entryPoint:"main"},this.fragmentStage={entryPoint:"main"},this.cRasterizationState={frontFace:"ccw",cullMode:"none",depthBias:0,depthBiasSlopeScale:0,depthBiasClamp:0},this.rasterizationState=this.cRasterizationState;const t={srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"};this.cColorStates=r(D.kMaxColorAttachments,()=>({format:"rgba8unorm",alphaBlend:t,colorBlend:t,writeMask:GPUColorWrite.ALL})),this.colorStateCount=1;const i={compare:"always",failOp:"keep",depthFailOp:"keep",passOp:"keep"};this.cDepthStencilState={format:"depth24plus-stencil8",depthWriteEnabled:!1,depthCompare:"always",stencilBack:i,stencilFront:i,stencilReadMask:255,stencilWriteMask:255},this.depthStencilState=void 0}set colorStateCount(e){this._colorStateCount=e,this.colorStates=this.cColorStates.slice(0,this._colorStateCount)}}D.kMaxColorAttachments=4;class y{constructor(){this._vertexBufferCount=0;this.cVertexBuffers=r(y.kMaxVertexBuffers,()=>({})),this.cAttributes=r(y.kMaxVertexAttributes,()=>({})),this.indexFormat="uint32",this._vertexBufferCount=0;for(let e=0;e<this.cAttributes.length;++e)this.cAttributes[e]={shaderLocation:0,offset:0,format:"float"};for(let e=0;e<this.cVertexBuffers.length;++e)this.cVertexBuffers[e].arrayStride=0,this.cVertexBuffers[e].stepMode="vertex",this.cVertexBuffers[e].attributes=[];this.cVertexBuffers[0].attributes=this.cAttributes,this.vertexBuffers=this.cVertexBuffers}set vertexBufferCount(e){this._vertexBufferCount=e,this.vertexBuffers=this.cVertexBuffers.slice(0,this._vertexBufferCount)}}y.kMaxVertexAttributes=16,y.kMaxVertexBuffers=16;class M{constructor(e,t,i){this.worldmatrices=new Array,this.textureMap={},this.bufferMap={},this._program=null,this._blend=i||!1,this._name=t||K.MODELMAX}dispose(){for(let e in this.bufferMap)null!==this.bufferMap[e]&&delete this.bufferMap[e];this.bufferMap={}}set program(e){this._program=e}prepareForDraw(){}updatePerInstanceUniforms(e){}draw(){}init(){}}class E extends M{constructor(e,t,i,r){super(e,t,i),this._preInstance=0,this._curInstance=0,this._fishPerOffset=0,this._aquarium=null,this._aquarium=r}updateFishPerUniforms(e,t,i,r,s,o,a,n,h){}prepareForDraw(){this._fishPerOffset=0;for(let e=0;e<this._name-K.MODELSMALLFISHA;++e){const t=te[e];this._fishPerOffset+=this._aquarium.fishCount[t.modelName-K.MODELSMALLFISHA]}const e=te[this._name-K.MODELSMALLFISHA];this._curInstance=this._aquarium.fishCount[e.modelName-K.MODELSMALLFISHA]}}class v extends M{constructor(e,t,i){super(e,t,i)}updateSeaweedModelTime(e){}}class U extends M{constructor(e,t,i,r,s){super(i,r,s),this.diffuseTexture=null,this.normalTexture=null,this.reflectionTexture=null,this.skyboxTexture=null,this.positionBuffer=null,this.normalBuffer=null,this.texCoordBuffer=null,this.tangentBuffer=null,this.biNormalBuffer=null,this.indicesBuffer=null,this.lightFactorUniforms=new g,this.worldUniformPer=new A,this._vertexStateDescriptor=null,this._contextWebGPU=null,this._programWebGPU=null,this._instance=0,this._contextWebGPU=e,this._vertexStateDescriptor=new y,this.lightFactorUniforms.shininess=50,this.lightFactorUniforms.specularFactor=1}dispose(){this._pipeline=null,this._groupLayoutModel=null,this._groupLayoutPer=null,this._pipelineLayout=null,this._bindGroupModel=null,this._bindGroupPer=null,this._lightFactorBuffer=null,this._worldBuffer=null}init(){this._programWebGPU=this._program,this.diffuseTexture=this.textureMap.diffuse,this.normalTexture=this.textureMap.normalMap,this.reflectionTexture=this.textureMap.reflectionMap,this.skyboxTexture=this.textureMap.skybox,this.positionBuffer=this.bufferMap.position,this.normalBuffer=this.bufferMap.normal,this.texCoordBuffer=this.bufferMap.texCoord,this.tangentBuffer=this.bufferMap.tangent,this.biNormalBuffer=this.bufferMap.binormal,this.indicesBuffer=this.bufferMap.indices,this.normalTexture&&this._name!==K.MODELGLOBEBASE?(this._vertexStateDescriptor.cVertexBuffers[0].arrayStride=this.positionBuffer.dataSize,this._vertexStateDescriptor.cAttributes[0].format="float3",this._vertexStateDescriptor.cAttributes[0].shaderLocation=0,this._vertexStateDescriptor.cAttributes[0].offset=0,this._vertexStateDescriptor.cVertexBuffers[0].attributes=[this._vertexStateDescriptor.cAttributes[0]],this._vertexStateDescriptor.cVertexBuffers[1].arrayStride=this.normalBuffer.dataSize,this._vertexStateDescriptor.cAttributes[1].format="float3",this._vertexStateDescriptor.cAttributes[1].shaderLocation=1,this._vertexStateDescriptor.cAttributes[1].offset=0,this._vertexStateDescriptor.cVertexBuffers[1].attributes=[this._vertexStateDescriptor.cAttributes[1]],this._vertexStateDescriptor.cVertexBuffers[2].arrayStride=this.texCoordBuffer.dataSize,this._vertexStateDescriptor.cAttributes[2].format="float2",this._vertexStateDescriptor.cAttributes[2].shaderLocation=2,this._vertexStateDescriptor.cAttributes[2].offset=0,this._vertexStateDescriptor.cVertexBuffers[2].attributes=[this._vertexStateDescriptor.cAttributes[2]],this._vertexStateDescriptor.cVertexBuffers[3].arrayStride=this.tangentBuffer.dataSize,this._vertexStateDescriptor.cAttributes[3].format="float3",this._vertexStateDescriptor.cAttributes[3].shaderLocation=3,this._vertexStateDescriptor.cAttributes[3].offset=0,this._vertexStateDescriptor.cVertexBuffers[3].attributes=[this._vertexStateDescriptor.cAttributes[3]],this._vertexStateDescriptor.cVertexBuffers[4].arrayStride=this.biNormalBuffer.dataSize,this._vertexStateDescriptor.cAttributes[4].format="float3",this._vertexStateDescriptor.cAttributes[4].shaderLocation=4,this._vertexStateDescriptor.cAttributes[4].offset=0,this._vertexStateDescriptor.cVertexBuffers[4].attributes=[this._vertexStateDescriptor.cAttributes[4]],this._vertexStateDescriptor.vertexBufferCount=5,this._vertexStateDescriptor.indexFormat="uint16"):(this._vertexStateDescriptor.cVertexBuffers[0].arrayStride=this.positionBuffer.dataSize,this._vertexStateDescriptor.cAttributes[0].format="float3",this._vertexStateDescriptor.cAttributes[0].shaderLocation=0,this._vertexStateDescriptor.cAttributes[0].offset=0,this._vertexStateDescriptor.cVertexBuffers[0].attributes=[this._vertexStateDescriptor.cAttributes[0]],this._vertexStateDescriptor.cVertexBuffers[1].arrayStride=this.normalBuffer.dataSize,this._vertexStateDescriptor.cAttributes[1].format="float3",this._vertexStateDescriptor.cAttributes[1].shaderLocation=1,this._vertexStateDescriptor.cAttributes[1].offset=0,this._vertexStateDescriptor.cVertexBuffers[1].attributes=[this._vertexStateDescriptor.cAttributes[1]],this._vertexStateDescriptor.cVertexBuffers[2].arrayStride=this.texCoordBuffer.dataSize,this._vertexStateDescriptor.cAttributes[2].format="float2",this._vertexStateDescriptor.cAttributes[2].shaderLocation=2,this._vertexStateDescriptor.cAttributes[2].offset=0,this._vertexStateDescriptor.cVertexBuffers[2].attributes=[this._vertexStateDescriptor.cAttributes[2]],this._vertexStateDescriptor.vertexBufferCount=3,this._vertexStateDescriptor.indexFormat="uint16"),this.skyboxTexture&&this.reflectionTexture&&this._name!==K.MODELGLOBEBASE?this._groupLayoutModel=this._contextWebGPU.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,type:"uniform-buffer"},{binding:1,visibility:GPUShaderStage.FRAGMENT,type:"sampler"},{binding:2,visibility:GPUShaderStage.FRAGMENT,type:"sampler"},{binding:3,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"},{binding:4,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"},{binding:5,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"},{binding:6,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"cube",textureComponentType:"float"}]}):this.normalTexture&&this._name!=K.MODELGLOBEBASE?this._groupLayoutModel=this._contextWebGPU.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,type:"uniform-buffer"},{binding:1,visibility:GPUShaderStage.FRAGMENT,type:"sampler"},{binding:2,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"},{binding:3,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"}]}):this._groupLayoutModel=this._contextWebGPU.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,type:"uniform-buffer"},{binding:1,visibility:GPUShaderStage.FRAGMENT,type:"sampler"},{binding:2,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"}]}),this._groupLayoutPer=this._contextWebGPU.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,type:"uniform-buffer"}]}),this._pipelineLayout=this._contextWebGPU.makeBasicPipelineLayout({bindGroupLayouts:[this._contextWebGPU.groupLayoutGeneral,this._contextWebGPU.groupLayoutWorld,this._groupLayoutModel,this._groupLayoutPer]}),this._pipeline=this._contextWebGPU.createRenderPipeline(this._pipelineLayout,this._programWebGPU,this._vertexStateDescriptor,this._blend),this._lightFactorBuffer=this._contextWebGPU.createBufferFromData(this.lightFactorUniforms.data,g.byteSize,GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM),this._worldBuffer=this._contextWebGPU.createBufferFromData(this.worldUniformPer.data,this.worldUniformPer.byteSize,GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM),this.skyboxTexture&&this.reflectionTexture&&this._name!==K.MODELGLOBEBASE?this._bindGroupModel=this._contextWebGPU.makeBindGroup({layout:this._groupLayoutModel,entries:[{binding:0,resource:{buffer:this._lightFactorBuffer,offset:0}},{binding:1,resource:this.reflectionTexture.sampler},{binding:2,resource:this.skyboxTexture.sampler},{binding:3,resource:this.diffuseTexture.textureView},{binding:4,resource:this.normalTexture.textureView},{binding:5,resource:this.reflectionTexture.textureView},{binding:6,resource:this.skyboxTexture.textureView}]}):this.normalTexture&&this._name!==K.MODELGLOBEBASE?this._bindGroupModel=this._contextWebGPU.makeBindGroup({layout:this._groupLayoutModel,entries:[{binding:0,resource:{buffer:this._lightFactorBuffer,offset:0}},{binding:1,resource:this.diffuseTexture.sampler},{binding:2,resource:this.diffuseTexture.textureView},{binding:3,resource:this.normalTexture.textureView}]}):this._bindGroupModel=this._contextWebGPU.makeBindGroup({layout:this._groupLayoutModel,entries:[{binding:0,resource:{buffer:this._lightFactorBuffer,offset:0}},{binding:1,resource:this.diffuseTexture.sampler},{binding:2,resource:this.diffuseTexture.textureView}]}),this._bindGroupPer=this._contextWebGPU.makeBindGroup({layout:this._groupLayoutPer,entries:[{binding:0,resource:{buffer:this._worldBuffer,offset:0}}]}),this._contextWebGPU.setBufferData(this._lightFactorBuffer,0,g.byteSize,this.lightFactorUniforms.data)}prepareForDraw(){this._contextWebGPU.updateBufferData(this._worldBuffer,this.worldUniformPer.data,this.worldUniformPer.byteSize)}draw(){const e=this._contextWebGPU.renderPass;e.setPipeline(this._pipeline),e.setBindGroup(0,this._contextWebGPU.bindGroupGeneral),e.setBindGroup(1,this._contextWebGPU.bindGroupWorld),e.setBindGroup(2,this._bindGroupModel),e.setBindGroup(3,this._bindGroupPer),e.setVertexBuffer(0,this.positionBuffer.buffer),e.setVertexBuffer(1,this.normalBuffer.buffer),e.setVertexBuffer(2,this.texCoordBuffer.buffer),this.tangentBuffer&&this.biNormalBuffer&&this._name!==K.MODELGLOBEBASE&&(e.setVertexBuffer(3,this.tangentBuffer.buffer),e.setVertexBuffer(4,this.biNormalBuffer.buffer)),e.setIndexBuffer(this.indicesBuffer.buffer,0),e.drawIndexed(this.indicesBuffer.totalComponents,this._instance,0,0,0),this._instance=0}updatePerInstanceUniforms(e){this.worldUniformPer.worldUniforms[this._instance]=e.clone(),++this._instance}}class G extends U{constructor(e,t,i,r,s){super(e,t,i,r,s),this.lightFactorUniforms.shininess=50,this.lightFactorUniforms.specularFactor=1}dispose(){super.dispose(),this._viewBuffer=null}init(){this._programWebGPU=this._program,this.diffuseTexture=this.textureMap.diffuse,this.normalTexture=this.textureMap.normalMap,this.reflectionTexture=this.textureMap.reflectionMap,this.skyboxTexture=this.textureMap.skybox,this.positionBuffer=this.bufferMap.position,this.normalBuffer=this.bufferMap.normal,this.texCoordBuffer=this.bufferMap.texCoord,this.tangentBuffer=this.bufferMap.tangent,this.biNormalBuffer=this.bufferMap.binormal,this.indicesBuffer=this.bufferMap.indices,this._vertexStateDescriptor.cVertexBuffers[0].arrayStride=this.positionBuffer.dataSize,this._vertexStateDescriptor.cAttributes[0].format="float3",this._vertexStateDescriptor.cAttributes[0].shaderLocation=0,this._vertexStateDescriptor.cAttributes[0].offset=0,this._vertexStateDescriptor.cVertexBuffers[0].attributes=[this._vertexStateDescriptor.cAttributes[0]],this._vertexStateDescriptor.cVertexBuffers[1].arrayStride=this.normalBuffer.dataSize,this._vertexStateDescriptor.cAttributes[1].format="float3",this._vertexStateDescriptor.cAttributes[1].shaderLocation=1,this._vertexStateDescriptor.cAttributes[1].offset=0,this._vertexStateDescriptor.cVertexBuffers[1].attributes=[this._vertexStateDescriptor.cAttributes[1]],this._vertexStateDescriptor.cVertexBuffers[2].arrayStride=this.texCoordBuffer.dataSize,this._vertexStateDescriptor.cAttributes[2].format="float2",this._vertexStateDescriptor.cAttributes[2].shaderLocation=2,this._vertexStateDescriptor.cAttributes[2].offset=0,this._vertexStateDescriptor.cVertexBuffers[2].attributes=[this._vertexStateDescriptor.cAttributes[2]],this._vertexStateDescriptor.cVertexBuffers[3].arrayStride=this.tangentBuffer.dataSize,this._vertexStateDescriptor.cAttributes[3].format="float3",this._vertexStateDescriptor.cAttributes[3].shaderLocation=3,this._vertexStateDescriptor.cAttributes[3].offset=0,this._vertexStateDescriptor.cVertexBuffers[3].attributes=[this._vertexStateDescriptor.cAttributes[3]],this._vertexStateDescriptor.cVertexBuffers[4].arrayStride=this.biNormalBuffer.dataSize,this._vertexStateDescriptor.cAttributes[4].format="float3",this._vertexStateDescriptor.cAttributes[4].shaderLocation=4,this._vertexStateDescriptor.cAttributes[4].offset=0,this._vertexStateDescriptor.cVertexBuffers[4].attributes=[this._vertexStateDescriptor.cAttributes[4]],this._vertexStateDescriptor.vertexBufferCount=5,this._vertexStateDescriptor.indexFormat="uint16",this._groupLayoutPer=this._contextWebGPU.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,type:"uniform-buffer"}]}),this._groupLayoutModel=this._contextWebGPU.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,type:"uniform-buffer"},{binding:1,visibility:GPUShaderStage.FRAGMENT,type:"sampler"},{binding:2,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture"}]}),this._pipelineLayout=this._contextWebGPU.makeBasicPipelineLayout({bindGroupLayouts:[this._contextWebGPU.groupLayoutGeneral,this._contextWebGPU.groupLayoutWorld,this._groupLayoutModel,this._groupLayoutPer]}),this._pipeline=this._contextWebGPU.createRenderPipeline(this._pipelineLayout,this._programWebGPU,this._vertexStateDescriptor,this._blend),this._lightFactorBuffer=this._contextWebGPU.createBufferFromData(this.lightFactorUniforms.data,g.byteSize,GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM),this._viewBuffer=this._contextWebGPU.createBufferFromData(this.worldUniformPer.data,20*this._contextWebGPU.calcConstantBufferByteSize(B.byteSize),GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM),this._bindGroupModel=this._contextWebGPU.makeBindGroup({layout:this._groupLayoutModel,entries:[{binding:0,resource:{buffer:this._lightFactorBuffer,offset:0}},{binding:1,resource:this.diffuseTexture.sampler},{binding:2,resource:this.diffuseTexture.textureView}]}),this._bindGroupPer=this._contextWebGPU.makeBindGroup({layout:this._groupLayoutPer,entries:[{binding:0,resource:{buffer:this._viewBuffer,offset:0}}]}),this._contextWebGPU.setBufferData(this._lightFactorBuffer,0,g.byteSize,this.lightFactorUniforms.data)}prepareForDraw(){}draw(){const e=this._contextWebGPU.renderPass;e.setPipeline(this._pipeline),e.setBindGroup(0,this._contextWebGPU.bindGroupGeneral),e.setBindGroup(1,this._contextWebGPU.bindGroupWorld),e.setBindGroup(2,this._bindGroupModel),e.setBindGroup(3,this._bindGroupPer),e.setVertexBuffer(0,this.positionBuffer.buffer),e.setVertexBuffer(1,this.normalBuffer.buffer),e.setVertexBuffer(2,this.texCoordBuffer.buffer),this.tangentBuffer&&this.biNormalBuffer&&(e.setVertexBuffer(3,this.tangentBuffer.buffer),e.setVertexBuffer(4,this.biNormalBuffer.buffer)),e.setIndexBuffer(this.indicesBuffer.buffer,0),e.drawIndexed(this.indicesBuffer.totalComponents,1,0,0,0)}updatePerInstanceUniforms(e){this.worldUniformPer.worldUniforms[0]=e.clone(),this._contextWebGPU.updateBufferData(this._viewBuffer,e.data,this._contextWebGPU.calcConstantBufferByteSize(B.byteSize))}}class L extends U{constructor(e,t,i,r,s){super(e,t,i,r,s),this.innerUniforms=new _,this.innerUniforms.eta=1,this.innerUniforms.tankColorFudge=.796,this.innerUniforms.refractionFudge=3}dispose(){super.dispose(),this._innerBuffer=null,this._viewBuffer=null}init(){this._programWebGPU=this._program,this.diffuseTexture=this.textureMap.diffuse,this.normalTexture=this.textureMap.normalMap,this.reflectionTexture=this.textureMap.reflectionMap,this.skyboxTexture=this.textureMap.skybox,this.positionBuffer=this.bufferMap.position,this.normalBuffer=this.bufferMap.normal,this.texCoordBuffer=this.bufferMap.texCoord,this.tangentBuffer=this.bufferMap.tangent,this.biNormalBuffer=this.bufferMap.binormal,this.indicesBuffer=this.bufferMap.indices,this._vertexStateDescriptor.cVertexBuffers[0].arrayStride=this.positionBuffer.dataSize,this._vertexStateDescriptor.cAttributes[0].format="float3",this._vertexStateDescriptor.cAttributes[0].shaderLocation=0,this._vertexStateDescriptor.cAttributes[0].offset=0,this._vertexStateDescriptor.cVertexBuffers[0].attributes=[this._vertexStateDescriptor.cAttributes[0]],this._vertexStateDescriptor.cVertexBuffers[1].arrayStride=this.normalBuffer.dataSize,this._vertexStateDescriptor.cAttributes[1].format="float3",this._vertexStateDescriptor.cAttributes[1].shaderLocation=1,this._vertexStateDescriptor.cAttributes[1].offset=0,this._vertexStateDescriptor.cVertexBuffers[1].attributes=[this._vertexStateDescriptor.cAttributes[1]],this._vertexStateDescriptor.cVertexBuffers[2].arrayStride=this.texCoordBuffer.dataSize,this._vertexStateDescriptor.cAttributes[2].format="float2",this._vertexStateDescriptor.cAttributes[2].shaderLocation=2,this._vertexStateDescriptor.cAttributes[2].offset=0,this._vertexStateDescriptor.cVertexBuffers[2].attributes=[this._vertexStateDescriptor.cAttributes[2]],this._vertexStateDescriptor.cVertexBuffers[3].arrayStride=this.tangentBuffer.dataSize,this._vertexStateDescriptor.cAttributes[3].format="float3",this._vertexStateDescriptor.cAttributes[3].shaderLocation=3,this._vertexStateDescriptor.cAttributes[3].offset=0,this._vertexStateDescriptor.cVertexBuffers[3].attributes=[this._vertexStateDescriptor.cAttributes[3]],this._vertexStateDescriptor.cVertexBuffers[4].arrayStride=this.biNormalBuffer.dataSize,this._vertexStateDescriptor.cAttributes[4].format="float3",this._vertexStateDescriptor.cAttributes[4].shaderLocation=4,this._vertexStateDescriptor.cAttributes[4].offset=0,this._vertexStateDescriptor.cVertexBuffers[4].attributes=[this._vertexStateDescriptor.cAttributes[4]],this._vertexStateDescriptor.vertexBufferCount=5,this._vertexStateDescriptor.indexFormat="uint16",this._groupLayoutModel=this._contextWebGPU.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,type:"uniform-buffer"},{binding:1,visibility:GPUShaderStage.FRAGMENT,type:"sampler"},{binding:2,visibility:GPUShaderStage.FRAGMENT,type:"sampler"},{binding:3,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"},{binding:4,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"},{binding:5,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"},{binding:6,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"cube",textureComponentType:"float"}]}),this._groupLayoutPer=this._contextWebGPU.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,type:"uniform-buffer"}]}),this._pipelineLayout=this._contextWebGPU.makeBasicPipelineLayout({bindGroupLayouts:[this._contextWebGPU.groupLayoutGeneral,this._contextWebGPU.groupLayoutWorld,this._groupLayoutModel,this._groupLayoutPer]}),this._pipeline=this._contextWebGPU.createRenderPipeline(this._pipelineLayout,this._programWebGPU,this._vertexStateDescriptor,this._blend),this._innerBuffer=this._contextWebGPU.createBufferFromData(this.innerUniforms.data,_.byteSize,GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM),this._viewBuffer=this._contextWebGPU.createBufferFromData(this.worldUniformPer.data,this._contextWebGPU.calcConstantBufferByteSize(this.worldUniformPer.byteSize),GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM),this._bindGroupModel=this._contextWebGPU.makeBindGroup({layout:this._groupLayoutModel,entries:[{binding:0,resource:{buffer:this._innerBuffer,offset:0}},{binding:1,resource:this.reflectionTexture.sampler},{binding:2,resource:this.skyboxTexture.sampler},{binding:3,resource:this.diffuseTexture.textureView},{binding:4,resource:this.normalTexture.textureView},{binding:5,resource:this.reflectionTexture.textureView},{binding:6,resource:this.skyboxTexture.textureView}]}),this._bindGroupPer=this._contextWebGPU.makeBindGroup({layout:this._groupLayoutPer,entries:[{binding:0,resource:{buffer:this._viewBuffer,offset:0}}]}),this._contextWebGPU.setBufferData(this._innerBuffer,0,_.byteSize,this.innerUniforms.data)}prepareForDraw(){}draw(){const e=this._contextWebGPU.renderPass;e.setPipeline(this._pipeline),e.setBindGroup(0,this._contextWebGPU.bindGroupGeneral),e.setBindGroup(1,this._contextWebGPU.bindGroupWorld),e.setBindGroup(2,this._bindGroupModel),e.setBindGroup(3,this._bindGroupPer),e.setVertexBuffer(0,this.positionBuffer.buffer),e.setVertexBuffer(1,this.normalBuffer.buffer),e.setVertexBuffer(2,this.texCoordBuffer.buffer),e.setVertexBuffer(3,this.tangentBuffer.buffer),e.setVertexBuffer(4,this.biNormalBuffer.buffer),e.setIndexBuffer(this.indicesBuffer.buffer,0),e.drawIndexed(this.indicesBuffer.totalComponents,1,0,0,0)}updatePerInstanceUniforms(e){this.worldUniformPer.worldUniforms[0]=e.clone(),this._contextWebGPU.updateBufferData(this._viewBuffer,e.data,this._contextWebGPU.calcConstantBufferByteSize(B.byteSize))}}class T extends E{constructor(e,t,i,r,s){super(i,r,s,t),this.fishVertexUniforms=new p,this.lightFactorUniforms=new g,this.diffuseTexture=null,this.normalTexture=null,this.reflectionTexture=null,this.skyboxTexture=null,this.positionBuffer=null,this.normalBuffer=null,this.texCoordBuffer=null,this.tangentBuffer=null,this.biNormalBuffer=null,this.indicesBuffer=null,this._vertexStateDescriptor=null,this._contextWebGPU=e,this._vertexStateDescriptor=new y,this._enableDynamicBufferOffset=t.toggleBitset[Z.ENABLEDYNAMICBUFFEROFFSET],this.lightFactorUniforms.shininess=5,this.lightFactorUniforms.specularFactor=.3;const o=te[r-K.MODELSMALLFISHA];this.fishVertexUniforms.fishLength=o.fishLength,this.fishVertexUniforms.fishBendAmount=o.fishBendAmount,this.fishVertexUniforms.fishWaveLength=o.fishWaveLength,this._curInstance=this._aquarium.fishCount[o.modelName-K.MODELSMALLFISHA],this._preInstance=this._curInstance}dispose(){this._pipeline=null,this._groupLayoutModel=null,this._pipelineLayout=null,this._bindGroupModel=null,this._fishVertexBuffer=null,this._lightFactorBuffer=null}init(){this._programWebGPU=this._program,this.diffuseTexture=this.textureMap.diffuse,this.normalTexture=this.textureMap.normalMap,this.reflectionTexture=this.textureMap.reflectionMap,this.skyboxTexture=this.textureMap.skybox,this.positionBuffer=this.bufferMap.position,this.normalBuffer=this.bufferMap.normal,this.texCoordBuffer=this.bufferMap.texCoord,this.tangentBuffer=this.bufferMap.tangent,this.biNormalBuffer=this.bufferMap.binormal,this.indicesBuffer=this.bufferMap.indices,this._vertexStateDescriptor.cVertexBuffers[0].arrayStride=this.positionBuffer.dataSize,this._vertexStateDescriptor.cAttributes[0].format="float3",this._vertexStateDescriptor.cAttributes[0].shaderLocation=0,this._vertexStateDescriptor.cAttributes[0].offset=0,this._vertexStateDescriptor.cVertexBuffers[0].attributes=[this._vertexStateDescriptor.cAttributes[0]],this._vertexStateDescriptor.cVertexBuffers[1].arrayStride=this.normalBuffer.dataSize,this._vertexStateDescriptor.cAttributes[1].format="float3",this._vertexStateDescriptor.cAttributes[1].shaderLocation=1,this._vertexStateDescriptor.cAttributes[1].offset=0,this._vertexStateDescriptor.cVertexBuffers[1].attributes=[this._vertexStateDescriptor.cAttributes[1]],this._vertexStateDescriptor.cVertexBuffers[2].arrayStride=this.texCoordBuffer.dataSize,this._vertexStateDescriptor.cAttributes[2].format="float2",this._vertexStateDescriptor.cAttributes[2].shaderLocation=2,this._vertexStateDescriptor.cAttributes[2].offset=0,this._vertexStateDescriptor.cVertexBuffers[2].attributes=[this._vertexStateDescriptor.cAttributes[2]],this._vertexStateDescriptor.cVertexBuffers[3].arrayStride=this.tangentBuffer.dataSize,this._vertexStateDescriptor.cAttributes[3].format="float3",this._vertexStateDescriptor.cAttributes[3].shaderLocation=3,this._vertexStateDescriptor.cAttributes[3].offset=0,this._vertexStateDescriptor.cVertexBuffers[3].attributes=[this._vertexStateDescriptor.cAttributes[3]],this._vertexStateDescriptor.cVertexBuffers[4].arrayStride=this.biNormalBuffer.dataSize,this._vertexStateDescriptor.cAttributes[4].format="float3",this._vertexStateDescriptor.cAttributes[4].shaderLocation=4,this._vertexStateDescriptor.cAttributes[4].offset=0,this._vertexStateDescriptor.cVertexBuffers[4].attributes=[this._vertexStateDescriptor.cAttributes[4]],this._vertexStateDescriptor.vertexBufferCount=5,this._vertexStateDescriptor.indexFormat="uint16",this.skyboxTexture&&this.reflectionTexture?this._groupLayoutModel=this._contextWebGPU.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,type:"uniform-buffer"},{binding:1,visibility:GPUShaderStage.FRAGMENT,type:"uniform-buffer"},{binding:2,visibility:GPUShaderStage.FRAGMENT,type:"sampler"},{binding:3,visibility:GPUShaderStage.FRAGMENT,type:"sampler"},{binding:4,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"},{binding:5,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"},{binding:6,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"},{binding:7,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"cube",textureComponentType:"float"}]}):this._groupLayoutModel=this._contextWebGPU.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,type:"uniform-buffer"},{binding:1,visibility:GPUShaderStage.FRAGMENT,type:"uniform-buffer"},{binding:2,visibility:GPUShaderStage.FRAGMENT,type:"sampler"},{binding:3,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"},{binding:4,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"}]}),this._pipelineLayout=this._contextWebGPU.makeBasicPipelineLayout({bindGroupLayouts:[this._contextWebGPU.groupLayoutGeneral,this._contextWebGPU.groupLayoutWorld,this._groupLayoutModel,this._contextWebGPU.groupLayoutFishPer]}),this._pipeline=this._contextWebGPU.createRenderPipeline(this._pipelineLayout,this._programWebGPU,this._vertexStateDescriptor,this._blend),this._fishVertexBuffer=this._contextWebGPU.createBufferFromData(this.fishVertexUniforms.data,p.byteSize,GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM),this._lightFactorBuffer=this._contextWebGPU.createBufferFromData(this.lightFactorUniforms.data,g.byteSize,GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM),this.skyboxTexture&&this.reflectionTexture?this._bindGroupModel=this._contextWebGPU.makeBindGroup({layout:this._groupLayoutModel,entries:[{binding:0,resource:{buffer:this._fishVertexBuffer,offset:0}},{binding:1,resource:{buffer:this._lightFactorBuffer,offset:0}},{binding:2,resource:this.reflectionTexture.sampler},{binding:3,resource:this.skyboxTexture.sampler},{binding:4,resource:this.diffuseTexture.textureView},{binding:5,resource:this.normalTexture.textureView},{binding:6,resource:this.reflectionTexture.textureView},{binding:7,resource:this.skyboxTexture.textureView}]}):this._bindGroupModel=this._contextWebGPU.makeBindGroup({layout:this._groupLayoutModel,entries:[{binding:0,resource:{buffer:this._fishVertexBuffer,offset:0}},{binding:1,resource:{buffer:this._lightFactorBuffer,offset:0}},{binding:2,resource:this.diffuseTexture.sampler},{binding:3,resource:this.diffuseTexture.textureView},{binding:4,resource:this.normalTexture.textureView}]}),this._contextWebGPU.setBufferData(this._lightFactorBuffer,0,g.byteSize,this.lightFactorUniforms.data),this._contextWebGPU.setBufferData(this._fishVertexBuffer,0,p.byteSize,this.fishVertexUniforms.data)}draw(){if(0==this._curInstance)return;const e=this._contextWebGPU.renderPass;if(e.setPipeline(this._pipeline),e.setBindGroup(0,this._contextWebGPU.bindGroupGeneral),e.setBindGroup(1,this._contextWebGPU.bindGroupWorld),e.setBindGroup(2,this._bindGroupModel),e.setVertexBuffer(0,this.positionBuffer.buffer),e.setVertexBuffer(1,this.normalBuffer.buffer),e.setVertexBuffer(2,this.texCoordBuffer.buffer),e.setVertexBuffer(3,this.tangentBuffer.buffer),e.setVertexBuffer(4,this.biNormalBuffer.buffer),e.setIndexBuffer(this.indicesBuffer.buffer,0),this._enableDynamicBufferOffset)for(let t=0;t<this._curInstance;++t){const i=256*(t+this._fishPerOffset);e.setBindGroup(3,this._contextWebGPU.bindGroupFishPers[0],[i]),e.drawIndexed(this.indicesBuffer.totalComponents,1,0,0,0)}else for(let t=0;t<this._curInstance;++t)e.setBindGroup(3,this._contextWebGPU.bindGroupFishPers[t+this._fishPerOffset]),e.drawIndexed(this.indicesBuffer.totalComponents,1,0,0,0)}updatePerInstanceUniforms(e){}updateFishPerUniforms(e,t,i,r,s,o,a,n,h){h+=this._fishPerOffset,this._contextWebGPU.fishPers[h].worldPosition[0]=e,this._contextWebGPU.fishPers[h].worldPosition[1]=t,this._contextWebGPU.fishPers[h].worldPosition[2]=i,this._contextWebGPU.fishPers[h].nextPosition[0]=r,this._contextWebGPU.fishPers[h].nextPosition[1]=s,this._contextWebGPU.fishPers[h].nextPosition[2]=o,this._contextWebGPU.fishPers[h].scale=a,this._contextWebGPU.fishPers[h].time=n}}class F extends E{constructor(e,t,i,s,o){super(i,s,o,t),this.fishVertexUniforms=new p,this.lightFactorUniforms=new g,this.fishPers=new Array,this.diffuseTexture=null,this.normalTexture=null,this.reflectionTexture=null,this.skyboxTexture=null,this.positionBuffer=null,this.normalBuffer=null,this.texCoordBuffer=null,this.tangentBuffer=null,this.biNormalBuffer=null,this.indicesBuffer=null,this._vertexStateDescriptor=null,this._programWebGPU=null,this._contextWebGPU=null,this._instance=0,this._contextWebGPU=e,this._vertexStateDescriptor=new y,this.lightFactorUniforms.shininess=5,this.lightFactorUniforms.specularFactor=.3;const a=te[s-K.MODELSMALLFISHAINSTANCEDDRAWS];this.fishVertexUniforms.fishLength=a.fishLength,this.fishVertexUniforms.fishBendAmount=a.fishBendAmount,this.fishVertexUniforms.fishWaveLength=a.fishWaveLength,this._instance=t.fishCount[a.modelName-K.MODELSMALLFISHA],this.fishPers=r(this._instance,()=>new c)}init(){0!=this._instance&&(this._programWebGPU=this._program,this.diffuseTexture=this.textureMap.diffuse,this.normalTexture=this.textureMap.normalMap,this.reflectionTexture=this.textureMap.reflectionMap,this.skyboxTexture=this.textureMap.skybox,this.positionBuffer=this.bufferMap.position,this.normalBuffer=this.bufferMap.normal,this.texCoordBuffer=this.bufferMap.texCoord,this.tangentBuffer=this.bufferMap.tangent,this.biNormalBuffer=this.bufferMap.binormal,this.indicesBuffer=this.bufferMap.indices,this._fishPersBuffer=this._contextWebGPU.createBuffer(c.byteSize*this._instance,GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST),this._vertexStateDescriptor.cVertexBuffers[0].arrayStride=this.positionBuffer.dataSize,this._vertexStateDescriptor.cAttributes[0].format="float3",this._vertexStateDescriptor.cAttributes[0].shaderLocation=0,this._vertexStateDescriptor.cAttributes[0].offset=0,this._vertexStateDescriptor.cVertexBuffers[0].attributes=[this._vertexStateDescriptor.cAttributes[0]],this._vertexStateDescriptor.cVertexBuffers[1].arrayStride=this.normalBuffer.dataSize,this._vertexStateDescriptor.cAttributes[1].format="float3",this._vertexStateDescriptor.cAttributes[1].shaderLocation=1,this._vertexStateDescriptor.cAttributes[1].offset=0,this._vertexStateDescriptor.cVertexBuffers[1].attributes=[this._vertexStateDescriptor.cAttributes[1]],this._vertexStateDescriptor.cVertexBuffers[2].arrayStride=this.texCoordBuffer.dataSize,this._vertexStateDescriptor.cAttributes[2].format="float2",this._vertexStateDescriptor.cAttributes[2].shaderLocation=2,this._vertexStateDescriptor.cAttributes[2].offset=0,this._vertexStateDescriptor.cVertexBuffers[2].attributes=[this._vertexStateDescriptor.cAttributes[2]],this._vertexStateDescriptor.cVertexBuffers[3].arrayStride=this.tangentBuffer.dataSize,this._vertexStateDescriptor.cAttributes[3].format="float3",this._vertexStateDescriptor.cAttributes[3].shaderLocation=3,this._vertexStateDescriptor.cAttributes[3].offset=0,this._vertexStateDescriptor.cVertexBuffers[3].attributes=[this._vertexStateDescriptor.cAttributes[3]],this._vertexStateDescriptor.cVertexBuffers[4].arrayStride=this.biNormalBuffer.dataSize,this._vertexStateDescriptor.cAttributes[4].format="float3",this._vertexStateDescriptor.cAttributes[4].shaderLocation=4,this._vertexStateDescriptor.cAttributes[4].offset=c.offsetof("worldPosition"),this._vertexStateDescriptor.cVertexBuffers[4].attributes=[this._vertexStateDescriptor.cAttributes[4]],this._vertexStateDescriptor.cVertexBuffers[5].arrayStride=c.byteSize,this._vertexStateDescriptor.cAttributes[5].format="float3",this._vertexStateDescriptor.cAttributes[5].shaderLocation=5,this._vertexStateDescriptor.cAttributes[5].offset=0,this._vertexStateDescriptor.cAttributes[6].format="float",this._vertexStateDescriptor.cAttributes[6].shaderLocation=6,this._vertexStateDescriptor.cAttributes[6].offset=c.offsetof("scale"),this._vertexStateDescriptor.cAttributes[7].format="float3",this._vertexStateDescriptor.cAttributes[7].shaderLocation=7,this._vertexStateDescriptor.cAttributes[7].offset=c.offsetof("nextPosition"),this._vertexStateDescriptor.cAttributes[8].format="float",this._vertexStateDescriptor.cAttributes[8].shaderLocation=8,this._vertexStateDescriptor.cAttributes[8].offset=c.offsetof("time"),this._vertexStateDescriptor.cVertexBuffers[5].attributes=this._vertexStateDescriptor.cAttributes.slice(5,9),this._vertexStateDescriptor.cVertexBuffers[5].stepMode="instance",this._vertexStateDescriptor.vertexBufferCount=6,this._vertexStateDescriptor.indexFormat="uint16",this.skyboxTexture&&this.reflectionTexture?this._groupLayoutModel=this._contextWebGPU.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,type:"uniform-buffer"},{binding:1,visibility:GPUShaderStage.FRAGMENT,type:"uniform-buffer"},{binding:2,visibility:GPUShaderStage.FRAGMENT,type:"sampler"},{binding:3,visibility:GPUShaderStage.FRAGMENT,type:"sampler"},{binding:4,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"},{binding:5,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"},{binding:6,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"},{binding:7,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"cube",textureComponentType:"float"}]}):this._groupLayoutModel=this._contextWebGPU.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,type:"uniform-buffer"},{binding:1,visibility:GPUShaderStage.FRAGMENT,type:"uniform-buffer"},{binding:2,visibility:GPUShaderStage.FRAGMENT,type:"sampler"},{binding:3,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"},{binding:4,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"}]}),this._groupLayoutPer=this._contextWebGPU.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,type:"uniform-buffer"}]}),this._pipelineLayout=this._contextWebGPU.makeBasicPipelineLayout({bindGroupLayouts:[this._contextWebGPU.groupLayoutGeneral,this._contextWebGPU.groupLayoutWorld,this._groupLayoutModel,this._groupLayoutPer]}),this._pipeline=this._contextWebGPU.createRenderPipeline(this._pipelineLayout,this._programWebGPU,this._vertexStateDescriptor,this._blend),this._fishVertexBuffer=this._contextWebGPU.createBufferFromData(this.fishVertexUniforms.data,p.byteSize,GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM),this._lightFactorBuffer=this._contextWebGPU.createBufferFromData(this.lightFactorUniforms.data,g.byteSize,GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM),this.skyboxTexture&&this.reflectionTexture?this._bindGroupModel=this._contextWebGPU.makeBindGroup({layout:this._groupLayoutModel,entries:[{binding:0,resource:{buffer:this._fishVertexBuffer,offset:0}},{binding:1,resource:{buffer:this._lightFactorBuffer,offset:0}},{binding:2,resource:this.reflectionTexture.sampler},{binding:3,resource:this.skyboxTexture.sampler},{binding:4,resource:this.diffuseTexture.textureView},{binding:5,resource:this.normalTexture.textureView},{binding:6,resource:this.reflectionTexture.textureView},{binding:7,resource:this.skyboxTexture.textureView}]}):this._bindGroupModel=this._contextWebGPU.makeBindGroup({layout:this._groupLayoutModel,entries:[{binding:0,resource:{buffer:this._fishVertexBuffer,offset:0}},{binding:1,resource:{buffer:this._lightFactorBuffer,offset:0}},{binding:2,resource:this.diffuseTexture.sampler},{binding:3,resource:this.diffuseTexture.textureView},{binding:4,resource:this.normalTexture.textureView}]}),this._contextWebGPU.setBufferData(this._lightFactorBuffer,0,g.byteSize,this.lightFactorUniforms.data),this._contextWebGPU.setBufferData(this._fishVertexBuffer,0,p.byteSize,this.fishVertexUniforms.data))}prepareForDraw(){}draw(){if(0==this._instance)return;this._contextWebGPU.setBufferData(this._fishPersBuffer,0,c.byteSize*this._instance,new Float32Array(c.toArray(this.fishPers)));const e=this._contextWebGPU.renderPass;e.setPipeline(this._pipeline),e.setBindGroup(0,this._contextWebGPU.bindGroupGeneral),e.setBindGroup(1,this._contextWebGPU.bindGroupWorld),e.setBindGroup(2,this._bindGroupModel),e.setVertexBuffer(0,this.positionBuffer.buffer),e.setVertexBuffer(1,this.normalBuffer.buffer),e.setVertexBuffer(2,this.texCoordBuffer.buffer),e.setVertexBuffer(3,this.tangentBuffer.buffer),e.setVertexBuffer(4,this.biNormalBuffer.buffer),e.setVertexBuffer(5,this._fishPersBuffer),e.setIndexBuffer(this.indicesBuffer.buffer,0),e.drawIndexed(this.indicesBuffer.totalComponents,this._instance,0,0,0)}updatePerInstanceUniforms(e){}updateFishPerUniforms(e,t,i,r,s,o,a,n,h){this.fishPers[h].worldPosition[0]=e,this.fishPers[h].worldPosition[1]=t,this.fishPers[h].worldPosition[2]=i,this.fishPers[h].nextPosition[0]=r,this.fishPers[h].nextPosition[1]=s,this.fishPers[h].nextPosition[2]=o,this.fishPers[h].scale=a,this.fishPers[h].time=n}dispose(){this._pipeline=null,this._groupLayoutModel=null,this._groupLayoutPer=null,this._pipelineLayout=null,this._bindGroupModel=null,this._bindGroupPer=null,this._fishVertexBuffer=null,this._lightFactorBuffer=null,this._fishPersBuffer=null,this.fishPers.length=0}}class w extends v{constructor(e,t,i,r,s){super(i,r,s),this.diffuseTexture=null,this.normalTexture=null,this.reflectionTexture=null,this.skyboxTexture=null,this.positionBuffer=null,this.normalBuffer=null,this.texCoordBuffer=null,this.indicesBuffer=null,this.lightFactorUniforms=new g,this.seaweedPer=new b,this.worldUniformPer=new A,this._vertexStateDescriptor=null,this._contextWebGPU=null,this._programWebGPU=null,this._aquarium=null,this._instance=0,this._contextWebGPU=e,this._aquarium=t,this._vertexStateDescriptor=new y,this.lightFactorUniforms.shininess=50,this.lightFactorUniforms.specularFactor=1}dispose(){this._pipeline=null,this._groupLayoutModel=null,this._groupLayoutPer=null,this._pipelineLayout=null,this._bindGroupModel=null,this._bindGroupPer=null,this._lightFactorBuffer=null,this._viewBuffer=null,this._timeBuffer=null}init(){this._programWebGPU=this._program,this.diffuseTexture=this.textureMap.diffuse,this.normalTexture=this.textureMap.normalMap,this.reflectionTexture=this.textureMap.reflectionMap,this.skyboxTexture=this.textureMap.skybox,this.positionBuffer=this.bufferMap.position,this.normalBuffer=this.bufferMap.normal,this.texCoordBuffer=this.bufferMap.texCoord,this.indicesBuffer=this.bufferMap.indices,this._vertexStateDescriptor.cVertexBuffers[0].arrayStride=this.positionBuffer.dataSize,this._vertexStateDescriptor.cAttributes[0].format="float3",this._vertexStateDescriptor.cAttributes[0].shaderLocation=0,this._vertexStateDescriptor.cAttributes[0].offset=0,this._vertexStateDescriptor.cVertexBuffers[0].attributes=[this._vertexStateDescriptor.cAttributes[0]],this._vertexStateDescriptor.cVertexBuffers[1].arrayStride=this.normalBuffer.dataSize,this._vertexStateDescriptor.cAttributes[1].format="float3",this._vertexStateDescriptor.cAttributes[1].shaderLocation=1,this._vertexStateDescriptor.cAttributes[1].offset=0,this._vertexStateDescriptor.cVertexBuffers[1].attributes=[this._vertexStateDescriptor.cAttributes[1]],this._vertexStateDescriptor.cVertexBuffers[2].arrayStride=this.texCoordBuffer.dataSize,this._vertexStateDescriptor.cAttributes[2].format="float2",this._vertexStateDescriptor.cAttributes[2].shaderLocation=2,this._vertexStateDescriptor.cAttributes[2].offset=0,this._vertexStateDescriptor.cVertexBuffers[2].attributes=[this._vertexStateDescriptor.cAttributes[2]],this._vertexStateDescriptor.vertexBufferCount=3,this._vertexStateDescriptor.indexFormat="uint16",this._groupLayoutModel=this._contextWebGPU.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,type:"uniform-buffer"},{binding:1,visibility:GPUShaderStage.FRAGMENT,type:"sampler"},{binding:2,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"}]}),this._groupLayoutPer=this._contextWebGPU.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,type:"uniform-buffer"},{binding:1,visibility:GPUShaderStage.VERTEX,type:"uniform-buffer"}]}),this._pipelineLayout=this._contextWebGPU.makeBasicPipelineLayout({bindGroupLayouts:[this._contextWebGPU.groupLayoutGeneral,this._contextWebGPU.groupLayoutWorld,this._groupLayoutModel,this._groupLayoutPer]}),this._pipeline=this._contextWebGPU.createRenderPipeline(this._pipelineLayout,this._programWebGPU,this._vertexStateDescriptor,this._blend),this._lightFactorBuffer=this._contextWebGPU.createBufferFromData(this.lightFactorUniforms.data,g.byteSize,GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM),this._timeBuffer=this._contextWebGPU.createBufferFromData(this.seaweedPer.data,4*this._contextWebGPU.calcConstantBufferByteSize(this.seaweedPer.byteSize),GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM),this._viewBuffer=this._contextWebGPU.createBufferFromData(this.worldUniformPer.data,this._contextWebGPU.calcConstantBufferByteSize(this.worldUniformPer.byteSize),GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM),this._bindGroupModel=this._contextWebGPU.makeBindGroup({layout:this._groupLayoutModel,entries:[{binding:0,resource:{buffer:this._lightFactorBuffer,offset:0}},{binding:1,resource:this.diffuseTexture.sampler},{binding:2,resource:this.diffuseTexture.textureView}]}),this._bindGroupPer=this._contextWebGPU.makeBindGroup({layout:this._groupLayoutPer,entries:[{binding:0,resource:{buffer:this._viewBuffer,offset:0}},{binding:1,resource:{buffer:this._timeBuffer,offset:0}}]}),this._contextWebGPU.setBufferData(this._lightFactorBuffer,0,g.byteSize,this.lightFactorUniforms.data)}prepareForDraw(){this._contextWebGPU.updateBufferData(this._viewBuffer,this.worldUniformPer.data,this._contextWebGPU.calcConstantBufferByteSize(this.worldUniformPer.byteSize)),this._contextWebGPU.updateBufferData(this._timeBuffer,this.seaweedPer.data,this._contextWebGPU.calcConstantBufferByteSize(this.seaweedPer.byteSize))}draw(){const e=this._contextWebGPU.renderPass;e.setPipeline(this._pipeline),e.setBindGroup(0,this._contextWebGPU.bindGroupGeneral),e.setBindGroup(1,this._contextWebGPU.bindGroupWorld),e.setBindGroup(2,this._bindGroupModel),e.setBindGroup(3,this._bindGroupPer),e.setVertexBuffer(0,this.positionBuffer.buffer),e.setVertexBuffer(1,this.normalBuffer.buffer),e.setVertexBuffer(2,this.texCoordBuffer.buffer),e.setIndexBuffer(this.indicesBuffer.buffer,0),e.drawIndexed(this.indicesBuffer.totalComponents,this._instance,0,0,0),this._instance=0}updatePerInstanceUniforms(e){this.worldUniformPer.worldUniforms[this._instance]=e.clone(),this.seaweedPer.time[this._instance]=this._aquarium.g.mclock+this._instance,this._instance++}updateSeaweedModelTime(e){}}class C{static LoadTextFileSynchronous(e){const t='LoadTextFileSynchronous failed to load url "'+e+'"';let i=null;if(!window.XMLHttpRequest)throw"XMLHttpRequest is disabled";if(i=new XMLHttpRequest,i.overrideMimeType&&i.overrideMimeType("text/plain"),i.open("GET",e,!1),i.send(null),4!=i.readyState)throw t;return i.responseText}static LoadTextFile(e,t){let i=null;if(!window.XMLHttpRequest)throw"XMLHttpRequest is disabled";i=new XMLHttpRequest,i.overrideMimeType&&i.overrideMimeType("text/plain; charset=utf-8"),i.open("GET",e,!0),i.onreadystatechange=function(){if(4==i.readyState){let r="",s=200==i.status||0==i.status;s&&(r=i.responseText),t(r,s?null:"could not load: "+e)}},i.send(null)}static LoadArrayBuffer(e,t){let i=null;if(!window.XMLHttpRequest)throw"XMLHttpRequest is disabled";if(i=new XMLHttpRequest,i.open("GET",e,!0),i.onreadystatechange=function(){if(4==i.readyState){let r=void 0,s=200==i.status||0==i.status;s&&(r=i.response),t(r,s?null:"could not load: "+e)}},void 0===i.responseType)throw"no support for binary files";i.responseType="arraybuffer",i.send(null)}static LoadJSON(e,t){let i=null;if(!window.XMLHttpRequest)throw"XMLHttpRequest is disabled";i=new XMLHttpRequest,i.overrideMimeType&&i.overrideMimeType("text/plain; charset=utf-8"),i.open("GET",e,!0),i.onreadystatechange=function(){if(4==i.readyState){let r=void 0,s=200==i.status||0==i.status;if(s)try{r=JSON.parse(i.responseText)}catch(e){s=!1}t(r,s?null:"could not load: "+e)}},i.send(null)}}var O=function(e,t,i,r){return new(i||(i=Promise))((function(s,o){function a(e){try{h(r.next(e))}catch(e){o(e)}}function n(e){try{h(r.throw(e))}catch(e){o(e)}}function h(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,n)}h((r=r.apply(e,t||[])).next())}))};class N extends class{constructor(e,t){e&&(this._vertexShaderCodePath=e),t&&(this._fragmentShaderCodePath=t)}get vertexShaderCode(){return this._vertexShaderCode}set vertexShaderCode(e){this._vertexShaderCode=e}get fragmentShaderCode(){return this._fragmentShaderCode}set fragmentShaderCode(e){this._fragmentShaderCode=e}dispose(){}setProgram(){}compileProgram(e,t){return O(this,void 0,void 0,(function*(){}))}loadProgram(){return O(this,void 0,void 0,(function*(){const e=new Array,t=(t,i)=>{e.push(new Promise((e,r)=>{C.LoadTextFile(t,(t,s)=>{switch(s&&(console.error("Unable to load shader: "+s),r(s)),i){case H.Vertex:this._vertexShaderCode=t,e();break;case H.Fragment:this._fragmentShaderCode=t,e();break;default:r("Unsupported stage: "+i)}})}))};return t(this._vertexShaderCodePath,H.Vertex),t(this._fragmentShaderCodePath,H.Fragment),Promise.all(e).then(()=>!0).catch(()=>(console.error("Unable to load program."),!1))}))}}{constructor(e,t,i){super(t,i),this._context=null,this._context=e}dispose(){this._vertexShaderModule=null,this._fragmentShaderModule=null,super.dispose()}compileProgram(e,t){return O(this,void 0,void 0,(function*(){return new Promise((i,r)=>{this.loadProgram().then(s=>{s?(this._fragmentShaderCode=this._fragmentShaderCode.replace(/^.*?\/\/ #noReflection$/gm,""),this._fragmentShaderCode=this._fragmentShaderCode.replace(/^.*?\/\/ #noNormalMap$/gm,""),e&&(this._fragmentShaderCode=this._fragmentShaderCode.replace(/diffuseColor.a/gm,t)),this._vertexShaderModule=this._context.createShaderModule(H.Vertex,this._vertexShaderCode),this._fragmentShaderModule=this._context.createShaderModule(H.Fragment,this._fragmentShaderCode),i()):(console.error("Unable to compile shader code."),r())})})}))}get vertexShaderModule(){return this._vertexShaderModule}get fragmentShaderModule(){return this._fragmentShaderModule}}const I=["GlobeOuter_EM_positive_x.jpg","GlobeOuter_EM_negative_x.jpg","GlobeOuter_EM_positive_y.jpg","GlobeOuter_EM_negative_y.jpg","GlobeOuter_EM_positive_z.jpg","GlobeOuter_EM_negative_z.jpg"];class R{constructor(e){this._path=e,this._imagePath=this._path+"../assets/",this._programPath=this._path+"../shaders/",this._propPlacementPath=this._path+"../assets/PropPlacement.js",this._fishBehaviorPath=this._path+"FishBehavior.json"}get imagePath(){return this._imagePath}get programPath(){return this._programPath}get propPlacementPath(){return this._propPlacementPath}get fishBehaviorPath(){return this._fishBehaviorPath}getSkyBoxUrls(){let e=[];for(let t=0;t<I.length;++t){const i=this._path+"../assets/"+I[t];e.push(i)}return e}getModelPath(e){return this._imagePath+e+".js"}}var W=function(e,t,i,r){return new(i||(i=Promise))((function(s,o){function a(e){try{h(r.next(e))}catch(e){o(e)}}function n(e){try{h(r.throw(e))}catch(e){o(e)}}function h(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,n)}h((r=r.apply(e,t||[])).next())}))};class V{constructor(e,t,i){this._width=0,this._height=0,this._name=e,this._urls=Array.isArray(t)?t:[t],this._flip=i}dispose(){}get name(){return this._name}static imageFlipY(e){const t=document.createElement("canvas");t.width=e.width,t.height=e.height;const i=t.getContext("2d");i.translate(0,e.height),i.scale(1,-1),i.drawImage(e,0,0,e.width,e.height),e.src=t.toDataURL()}static loadImage(e,t){return W(this,void 0,void 0,(function*(){return new Promise((i,r)=>W(this,void 0,void 0,(function*(){let s=[];for(let i=0;i<e.length;++i){const o=new Image;try{o.src=e[i],yield o.decode(),t&&V.imageFlipY(o)}catch(t){console.error("Unable to load image from url: "+e[i]),r(s)}s.push(o)}i(s)})))}))}resizeImage(e,t,i){const r=document.createElement("canvas");r.width=e.width,r.height=e.height;const s=r.getContext("2d");s.drawImage(e,0,0,t,i);return s.getImageData(0,0,t,i)}isPowerOf2(e){return 0==(e&e-1)}destroyImageData(e){e.length=0}loadTexture(){}getImagePixels(e){const t=document.createElement("canvas");t.width=e.width,t.height=e.height;const i=t.getContext("2d");this._flip&&(i.translate(0,e.height),i.scale(1,-1)),i.drawImage(e,0,0,e.width,e.height);const r=i.getImageData(0,0,e.width,e.height);let s=null;const o=256*Math.ceil(4*e.width/256);if(o==4*e.width)s=r.data;else{s=new Uint8ClampedArray(o*e.height);let t=0;for(let i=0;i<e.height;++i)for(let a=0;a<e.width;++a){let e=4*a+i*o;s[e]=r.data[t],s[e+1]=r.data[t+1],s[e+2]=r.data[t+2],s[e+3]=r.data[t+3],t+=4}}return s}}class k extends V{constructor(e,t,i){super(t,Array.isArray(i)?i:[i],!Array.isArray(i)),this._context=null,this._gpuTextureHelper=null,this._textureDimension="2d",this._textureViewDimension=Array.isArray(i)?"cube":"2d",this._format="rgba8unorm",this._context=e,this._gpuTextureHelper=new z(e)}dispose(){this.destroyImageData(this._pixelVec),this.destroyImageData(this._resizedVec),this._textureView=null,this._texture=null,this._sampler=null}get textureDimension(){return this._textureDimension}get textureViewDimension(){return this._textureViewDimension}get textureId(){return this._texture}get sampler(){return this._sampler}get textureView(){return this._textureView}_onImageLoaded(){this._images.length>0&&(this._width=this._images[0].width,this._height=this._images[0].height,this._pixelVec=r(this._images.length,()=>null))}loadTexture(){return W(this,void 0,void 0,(function*(){return Promise.resolve().then(()=>W(this,void 0,void 0,(function*(){if(this._images=yield V.loadImage(this._urls,this._flip),this._onImageLoaded(),"cube"===this._textureViewDimension){const e={dimension:this._textureDimension,size:{width:this._width,height:this._height,depth:6},sampleCount:1,format:this._format,mipLevelCount:1,usage:GPUTextureUsage.COPY_DST|GPUTextureUsage.SAMPLED};this._texture=this._context.createTexture(e);for(let e=0;e<6;++e){let[t,i]=this._context.createBufferMapped(GPUBufferUsage.COPY_SRC|GPUBufferUsage.MAP_WRITE,this._width*this._height*4);this._pixelVec[e]=this.getImagePixels(this._images[e]),new Uint8Array(i).set(this._pixelVec[e]),t.unmap();const r=this._context.createBufferCopyView(t,0,4*this._width,this._height),s=this._context.createTextureCopyView(this._texture,0,e,{x:0,y:0,z:0}),o={width:this._width,height:this._height,depth:1};this._context.commandBuffers.push(this._context.copyBufferToTexture(r,s,o))}const t={dimension:"cube",format:this._format,baseMipLevel:0,mipLevelCount:1,baseArrayLayer:0,arrayLayerCount:6};this._textureView=this._texture.createView(t);let i={addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",addressModeW:"clamp-to-edge",minFilter:"linear",magFilter:"linear",mipmapFilter:"nearest"};this._sampler=this._context.createSampler(i)}else{this._texture=yield this._gpuTextureHelper.generateMipmappedTexture(this._images[0]),this._width=this._gpuTextureHelper.imageBitmapSize.width,this._height=this._gpuTextureHelper.imageBitmapSize.height;const e={dimension:"2d",format:this._format,baseMipLevel:0,mipLevelCount:Math.trunc(Math.floor(Math.log2(Math.min(this._width,this._height))))+1,baseArrayLayer:0,arrayLayerCount:1};this._textureView=this._texture.createView(e);let t={addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",addressModeW:"clamp-to-edge",minFilter:"linear",magFilter:"linear",mipmapFilter:this.isPowerOf2(this._width)&&this.isPowerOf2(this._height)?"linear":"nearest"};this._sampler=this._context.createSampler(t)}})))}))}}class z{constructor(e){this._context=null,this._device=null,this._context=e,this._device=this._context.device;this.mipmapSampler=this._context.createSampler({minFilter:"linear"}),this.mipmapBindGroupLayout=this._context.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,type:"sampler"},{binding:1,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture"}]}),this.mipmapPipeline=this._device.createRenderPipeline({layout:this._device.createPipelineLayout({bindGroupLayouts:[this.mipmapBindGroupLayout]}),vertexStage:{module:this._device.createShaderModule({code:this._context.glslang.compileGLSL("#version 450\n            const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));\n            const vec2 tex[4] = vec2[4](vec2(0.0f, 0.0f), vec2(1.0f, 0.0f), vec2(0.0f, 1.0f), vec2(1.0f, 1.0f));\n            layout(location = 0) out vec2 vTex;\n            void main() {\n            vTex = tex[gl_VertexIndex];\n            gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);\n            }\n        ","vertex")}),entryPoint:"main"},fragmentStage:{module:this._device.createShaderModule({code:this._context.glslang.compileGLSL("#version 450\n            layout(set = 0, binding = 0) uniform sampler imgSampler;\n            layout(set = 0, binding = 1) uniform texture2D img;\n            layout(location = 0) in vec2 vTex;\n            layout(location = 0) out vec4 outColor;\n            void main() {\n            outColor = texture(sampler2D(img, imgSampler), vTex);\n            }\n        ","fragment")}),entryPoint:"main"},primitiveTopology:"triangle-strip",colorStates:[{format:"rgba8unorm"}]})}generateMipmappedTexture(e){return W(this,void 0,void 0,(function*(){return new Promise((t,i)=>W(this,void 0,void 0,(function*(){let i=yield createImageBitmap(e,0,0,e.width,e.height);this.imageBitmapSize={width:i.width,height:i.height,depth:1};const r={width:i.width,height:i.height,depth:1},s=Math.floor(Math.log2(Math.max(i.width,i.height)))+1,o=this._device.createTexture({size:r,format:"rgba8unorm",usage:GPUTextureUsage.COPY_DST|GPUTextureUsage.SAMPLED|GPUTextureUsage.OUTPUT_ATTACHMENT,mipLevelCount:s});this._device.defaultQueue.copyImageBitmapToTexture({imageBitmap:i},{texture:o},r);const a=this._device.createTexture({size:r,format:"rgba8unorm",usage:GPUTextureUsage.COPY_SRC|GPUTextureUsage.SAMPLED|GPUTextureUsage.OUTPUT_ATTACHMENT,mipLevelCount:s}),n=this._device.createCommandEncoder({});for(let e=1;e<s;++e){n.beginRenderPass({colorAttachments:[{attachment:o.createView({baseMipLevel:e,mipLevelCount:1}),loadValue:{r:1,g:0,b:0,a:0}}]}).endPass()}for(let e=0;e<s;++e){const t=this._device.createBindGroup({layout:this.mipmapBindGroupLayout,entries:[{binding:0,resource:this.mipmapSampler},{binding:1,resource:o.createView({baseMipLevel:Math.max(0,e-1),mipLevelCount:1})}]}),i=n.beginRenderPass({colorAttachments:[{attachment:a.createView({baseMipLevel:e,mipLevelCount:1}),loadValue:"load"}]});i.setPipeline(this.mipmapPipeline),i.setBindGroup(0,t),i.draw(4,1,0,0),i.endPass(),n.copyTextureToTexture({texture:a,mipLevel:e},{texture:o,mipLevel:e},r),r.width=Math.ceil(r.width/2),r.height=Math.ceil(r.height/2)}this._device.defaultQueue.submit([n.finish()]),o.destroy(),t(a)})))}))}}var H,Y=function(e,t,i,r){return new(i||(i=Promise))((function(s,o){function a(e){try{h(r.next(e))}catch(e){o(e)}}function n(e){try{h(r.throw(e))}catch(e){o(e)}}function h(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,n)}h((r=r.apply(e,t||[])).next())}))};!function(e){e[e.Vertex=0]="Vertex",e[e.Fragment=1]="Fragment",e[e.Compute=2]="Compute"}(H||(H={}));class q extends class{constructor(){this._resourceHelper=null,this._availableToggleBitset=r(Z.TOGGLEMAX,()=>!1)}get clientWidth(){return this._clientWidth}get clientHeight(){return this._clientHeight}get availableToggleBitset(){return this._availableToggleBitset}get resourceHelper(){return this._resourceHelper}initialize(e,t){return Promise.resolve().then(()=>!1)}createTextureWebGPU(e,t){return Promise.resolve().then(()=>null)}shouldQuit(){return!1}keyBoardQuit(){return!1}createBufferWebGPU(e,t,i){return null}createProgram(e,t){return null}doFlush(e){}terminate(){}flush(){}preFrame(){}updateFPS(e,t,i){}showFPS(){}reallocResource(e,t,i){}updateAllFishData(){}beginRenderPass(){}createModel(e,t,i,r){return null}initGeneralResources(e){}updateWorldlUniforms(e){}setWindowSize(e,t){0!==e&&(this._clientWidth=e),0!==t&&(this._clientHeight=t)}_initAvailableToggleBitset(){}}{constructor(){super(),this._isSwapchainOutOfDate=!1,this._renderPassDescriptor=null,this._preferredSwapChainFormat="rgba8unorm",this._enableMSAA=!1,this._enableDynamicBufferOffset=!1,this._enableFullScreenMode=!1,this._bufferManager=null,this.commandBuffers=new Array,this.bindGroupFishPers=new Array,this.fishPers=new Array,this._resourceHelper=new R(document.location.toString()),this._initAvailableToggleBitset()}get glslang(){return this._glslang}dispose(){this._sceneRenderTargetView=null,this._sceneDepthStencilView=null,this._backbufferView=null,this._pipeline=null,this._bindGroup=null,this._lightWorldPositionBuffer=null,this._lightBuffer=null,this._fogBuffer=null,this._commandEncoder=null,this.commandBuffers.length=0,this._renderPass=null,this._renderPassDescriptor=null,this.groupLayoutGeneral=null,this.bindGroupGeneral=null,this.groupLayoutWorld=null,this.bindGroupWorld=null,this.groupLayoutFishPer=null,this._destroyFishResource(),this._swapChain=null,this.queue=null,this.device=null}initialize(e,t){return Y(this,void 0,void 0,(function*(){return this._canvas=t,this._enableMSAA=e[Z.ENABLEMSAAx4],this._disableControlPanel=e[Z.DISABLECONTROLPANEL],this._enableFullScreenMode=e[Z.ENABLEFULLSCREENMODE],this._syncClientSize(),new Promise((i,r)=>Y(this,void 0,void 0,(function*(){try{this.adapter=yield navigator.gpu.requestAdapter(),this.device=yield this.adapter.requestDevice(),"function"==typeof this.device.addEventListener&&this.device.addEventListener("uncapturederror",e=>{console.error(e)}),this._glslang=yield function(){return f(this,void 0,void 0,(function*(){if(void 0!==l)return l;const e=yield import("https://unpkg.com/@webgpu/glslang@0.0.15/dist/web-devel/glslang.js");return l=yield e.default(),l}))}(),this.queue=this.device.defaultQueue,this._gpuCanvasContext=t.getContext("gpupresent"),this._preferredSwapChainFormat=yield this._gpuCanvasContext.getSwapChainPreferredFormat(this.device),this._swapChain=this._gpuCanvasContext.configureSwapChain({device:this.device,format:this._preferredSwapChainFormat}),this._enableMSAA&&(this._sceneRenderTargetView=this.createMultisampledRenderTargetView()),this._sceneDepthStencilView=this.createDepthStencilView(),window.addEventListener("resize",this._framebufferResizeCallback),this._bufferManager=new u(this,!e[Z.BUFFERMAPPINGASYNC])}catch(e){return r("Unable initialize the WebGPU context "+e),!1}i(!0)})))}))}_initAvailableToggleBitset(){this._availableToggleBitset[Z.ENABLEMSAAx4]=!0,this._availableToggleBitset[Z.ENABLEINSTANCEDDRAWS]=!0,this._availableToggleBitset[Z.ENABLEDYNAMICBUFFEROFFSET]=!1,this._availableToggleBitset[Z.DISCRETEGPU]=!0,this._availableToggleBitset[Z.INTEGRATEDGPU]=!0,this._availableToggleBitset[Z.ENABLEFULLSCREENMODE]=!0,this._availableToggleBitset[Z.BUFFERMAPPINGASYNC]=!1,this._availableToggleBitset[Z.TURNOFFVSYNC]=!0,this._availableToggleBitset[Z.DISABLED3D12RENDERPASS]=!0,this._availableToggleBitset[Z.DISABLEWEBGPUVALIDATION]=!0,this._availableToggleBitset[Z.SIMULATINGFISHCOMEANDGO]=!0}_syncClientSize(){const e=this._canvas.offsetWidth*window.devicePixelRatio,t=this._canvas.offsetHeight*window.devicePixelRatio;this._enableFullScreenMode?(this._canvas.width=window.innerWidth||e,this._canvas.height=window.innerHeight||t):(this._canvas.width=e,this._canvas.height=t),this.setWindowSize(this._canvas.width,this._canvas.height)}_framebufferResizeCallback(){this._isSwapchainOutOfDate=!0}createTextureWebGPU(e,t){return Promise.resolve().then(()=>Y(this,void 0,void 0,(function*(){const i=new k(this,e,t);return yield i.loadTexture(),i})))}createTexture(e){return this.device.createTexture(e)}createSampler(e){return this.device.createSampler(e)}createBufferFromData(e,t,i){const r=this.createBuffer(t,i|GPUBufferUsage.COPY_DST);return this.setBufferData(r,0,t,e),r}createBufferCopyView(e,t,i,r){return{buffer:e,offset:t,bytesPerRow:i,rowsPerImage:r}}createTextureCopyView(e,t,i,r){return{texture:e,mipLevel:t,arrayLayer:i,origin:r}}copyBufferToTexture(e,t,i){const r=this.device.createCommandEncoder();r.copyBufferToTexture(e,t,i);return r.finish()}copyBufferToBuffer(e,t,i,r,s){const o=this.device.createCommandEncoder();o.copyBufferToBuffer(e,t,i,r,s);return o.finish()}createShaderModule(e,t){const i=e==H.Vertex?"vertex":e==H.Fragment?"fragment":"compute";return this.device.createShaderModule({code:this._glslang.compileGLSL(t,i),source:t,transform:e=>this._glslang.compileGLSL(e,i)})}makeBindGroupLayout(e){return this.device.createBindGroupLayout(e)}makeBasicPipelineLayout(e){return this.device.createPipelineLayout(e)}createRenderPipeline(e,t,i,r){const s=t.vertexShaderModule,o=t.fragmentShaderModule,a={operation:"add",srcFactor:r?"src-alpha":"one",dstFactor:r?"one-minus-src-alpha":"zero"},n={format:this._preferredSwapChainFormat,colorBlend:a,alphaBlend:a,writeMask:GPUColorWrite.ALL},h=new D(this.device);h.layout=e,h.vertexStage.module=s,h.fragmentStage.module=o,h.vertexState=i,h.depthStencilState=h.cDepthStencilState,h.cDepthStencilState.format="depth24plus-stencil8",h.colorStates[0]=n,h.colorStates[0].format=this._preferredSwapChainFormat,h.cDepthStencilState.depthWriteEnabled=!0,h.cDepthStencilState.depthCompare="less",h.primitiveTopology="triangle-list",h.sampleCount=this._enableMSAA?4:1,h.rasterizationState={frontFace:"ccw",cullMode:"back",depthBias:0,depthBiasSlopeScale:0,depthBiasClamp:0};return this.device.createRenderPipeline(h)}createMultisampledRenderTargetView(){const e={dimension:"2d",size:{width:this._clientWidth,height:this._clientHeight,depth:1},sampleCount:4,format:this._preferredSwapChainFormat,mipLevelCount:1,usage:GPUTextureUsage.OUTPUT_ATTACHMENT};return this.device.createTexture(e).createView()}createDepthStencilView(){const e={dimension:"2d",size:{width:this._clientWidth,height:this._clientHeight,depth:1},sampleCount:this._enableMSAA?4:1,format:"depth24plus-stencil8",mipLevelCount:1,usage:GPUTextureUsage.OUTPUT_ATTACHMENT|GPUTextureUsage.COPY_DST};return this.device.createTexture(e).createView()}createBuffer(e,t){const i={size:e,usage:t};return this.device.createBuffer(i)}setBufferData(e,t,i,r){let[s,o]=this.createBufferMapped(GPUBufferUsage.MAP_WRITE|GPUBufferUsage.COPY_SRC,i);(r instanceof Uint16Array?new Uint16Array(o):new Float32Array(o)).set(r),s.unmap();const a=this.copyBufferToBuffer(s,0,e,0,i);this.commandBuffers.push(a)}makeBindGroup(e){return this.device.createBindGroup(e)}initGeneralResources(e){this.groupLayoutGeneral=this.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,type:"uniform-buffer"},{binding:1,visibility:GPUShaderStage.FRAGMENT,type:"uniform-buffer"}]}),this._lightBuffer=this.createBufferFromData(e.lightUniforms.data,S.byteSize,GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM),this._fogBuffer=this.createBufferFromData(e.fogUniforms.data,m.byteSize,GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM),this.bindGroupGeneral=this.makeBindGroup({layout:this.groupLayoutGeneral,entries:[{binding:0,resource:{buffer:this._lightBuffer,offset:0}},{binding:1,resource:{buffer:this._fogBuffer,offset:0}}]}),this.setBufferData(this._lightBuffer,0,S.byteSize,e.lightUniforms.data),this.setBufferData(this._fogBuffer,0,m.byteSize,e.fogUniforms.data),this.groupLayoutWorld=this.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,type:"uniform-buffer"}]}),this._lightWorldPositionBuffer=this.createBufferFromData(e.lightWorldPositionUniform.data,this.calcConstantBufferByteSize(x.byteSize),GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM),this.bindGroupWorld=this.makeBindGroup({layout:this.groupLayoutWorld,entries:[{binding:0,resource:{buffer:this._lightWorldPositionBuffer,offset:0}}]});const t=e.toggleBitset[Z.ENABLEDYNAMICBUFFEROFFSET];this.groupLayoutFishPer=this.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,type:"uniform-buffer",hasDynamicOffset:!!t||void 0}]}),this.reallocResource(e.preFishCount,e.curFishCount,t)}updateWorldlUniforms(e){this.updateBufferData(this._lightWorldPositionBuffer,e.lightWorldPositionUniform.data,this.calcConstantBufferByteSize(x.byteSize))}createBufferWebGPU(e,t,i){return new a(this,t.length,e,t,i)}createProgram(e,t){return new N(this,e,t)}doFlush(e){this._renderPass.endPass(),this._bufferManager.flush();const t=this._commandEncoder.finish();this.commandBuffers.push(t),this.flush()}flush(){this.queue.submit(this.commandBuffers),this.commandBuffers.length=0}preFrame(){this._isSwapchainOutOfDate&&(this._syncClientSize(),this._enableMSAA&&(this._sceneRenderTargetView=this.createMultisampledRenderTargetView()),this._sceneDepthStencilView=this.createDepthStencilView(),this._isSwapchainOutOfDate=!1),this._commandEncoder=this.device.createCommandEncoder(),this._backbufferView=this._swapChain.getCurrentTexture().createView(),this._enableMSAA?(this._renderPassDescriptor=new P([this._sceneRenderTargetView],this._sceneDepthStencilView),this._renderPassDescriptor.cColorAttachments[0].resolveTarget=this._backbufferView,this._renderPassDescriptor.cColorAttachments[0].storeOp="clear",this._renderPassDescriptor.cColorAttachments[0].loadValue={r:0,g:.8,b:1,a:0},this._renderPassDescriptor.colorAttachmentCount=1):(this._renderPassDescriptor=new P([this._backbufferView],this._sceneDepthStencilView),this._renderPassDescriptor.cColorAttachments[0].storeOp="store",this._renderPassDescriptor.cColorAttachments[0].loadValue={r:0,g:.8,b:1,a:0},this._renderPassDescriptor.colorAttachmentCount=1),this._renderPass=this._commandEncoder.beginRenderPass(this._renderPassDescriptor)}createModel(e,t,i,r){let s=null;switch(t){case J.FISH:s=new T(this,e,t,i,r);break;case J.FISHINSTANCEDDRAW:s=new F(this,e,t,i,r);break;case J.GENERIC:s=new U(this,e,t,i,r);break;case J.INNER:s=new L(this,e,t,i,r);break;case J.SEAWEED:s=new w(this,e,t,i,r);break;case J.OUTSIDE:s=new G(this,e,t,i,r);break;default:s=null,console.error("Can not create model type: "+t)}return s}reallocResource(e,t,i){if(this._preTotalInstance=e,this._curTotalInstance=t,this._enableDynamicBufferOffset=i,0===t)return;if(e>=t)return;this._destroyFishResource(),this.fishPers=r(t,()=>new d),this.bindGroupFishPers=i?Array.from([null]):r(t,()=>null);const s=this.calcConstantBufferByteSize(d.byteSize*t);if(this.fishPersBuffer=this.createBuffer(s,GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM),i)this.bindGroupFishPers[0]=this.makeBindGroup({layout:this.groupLayoutFishPer,entries:[{binding:0,resource:{buffer:this.fishPersBuffer,offset:0}}]});else for(let e=0;e<t;++e)this.bindGroupFishPers[e]=this.makeBindGroup({layout:this.groupLayoutFishPer,entries:[{binding:0,resource:{buffer:this.fishPersBuffer,offset:this.calcConstantBufferByteSize(d.byteSize*e)}}]})}createBufferMapped(e,t){const i={size:t,usage:e},r=this.device.createBufferMapped(i);return s(r[1].byteLength===t,"Invalid buffer size."),r}get renderPass(){return this._renderPass}waitABit(){}createCommandEncoder(){return this.device.createCommandEncoder()}updateAllFishData(){const e=this.calcConstantBufferByteSize(d.byteSize*this._curTotalInstance);let t=[];for(let e=0;e<this._curTotalInstance;++e)t=t.concat(this.fishPers[e].getAsArray());this.updateBufferData(this.fishPersBuffer,new Float32Array(t),e)}updateBufferData(e,t,i){let r=0;const s=this._bufferManager.allocate(i,r),o=s.buffer;r=s.offset,null!==o?o.push(this._bufferManager.encoder,e,r,0,t,i):console.error("Memory upper limit.")}_destroyFishResource(){if(this.fishPersBuffer=null,this.fishPers.length>0&&(this.fishPers.length=0),this._enableDynamicBufferOffset)null!==this.bindGroupFishPers&&null!==this.bindGroupFishPers[0]&&(this.bindGroupFishPers[0]=null);else if(null!==this.bindGroupFishPers)for(let e=0;e<this._preTotalInstance;e++)null!==this.bindGroupFishPers[e]&&(this.bindGroupFishPers[e]=null);this.bindGroupFishPers.length=0,this._bufferManager.destroyBufferPool()}calcConstantBufferByteSize(e){return e+255&-256}}q.kSwapchainBackBufferUsage=GPUTextureUsage.OUTPUT_ATTACHMENT|GPUTextureUsage.COPY_SRC;class X{constructor(){this._totalTime=1*X.NUM_FRAMES_TO_AVERAGE,this._timeTable=r(X.NUM_FRAMES_TO_AVERAGE,()=>1),this._timeTableCursor=0,this._historyFPS=r(X.NUM_HISTORY_DATA,()=>1),this._historyFrameTime=r(X.NUM_HISTORY_DATA,()=>100),this._logFPS=[],this._averageFPS=0,this._averageFrameTime=0}get averageFPS(){return this._averageFPS}get historyFPS(){return this._historyFPS}get averageFrameTime(){return this._averageFrameTime}get historyFrameTime(){return this._historyFrameTime}update(e,t,i){this._totalTime+=e-this._timeTable[this._timeTableCursor],this._timeTable[this._timeTableCursor]=e,this._timeTableCursor++,this._timeTableCursor===X.NUM_FRAMES_TO_AVERAGE&&(this._timeTableCursor=0),this._averageFPS=Math.floor(1/(this._totalTime/(1*X.NUM_FRAMES_TO_AVERAGE))+.5);for(let e=0;e<X.NUM_HISTORY_DATA;++e)this._historyFPS[e]=this._historyFPS[e+1],this._historyFrameTime[e]=this._historyFrameTime[e+1];this._historyFPS[X.NUM_HISTORY_DATA-1]=this._averageFPS,this._historyFrameTime[X.NUM_HISTORY_DATA-1]=1e3/this._averageFPS,this._averageFrameTime=this._historyFrameTime[X.NUM_HISTORY_DATA-1],i-t>5&&i-t<25&&this._logFPS.push(this._averageFPS)}variance(){let e=0;for(let t=0;t<this._logFPS.length;++t)e+=this._logFPS[t];e/=this._logFPS.length;let t=0;for(let i=0;i<this._logFPS.length;i++)t+=Math.pow(this._logFPS[i]-e,2);return t/=this._logFPS.length,t<X.FPS_VALID_THRESHOLD?Math.ceil(e):0}}X.NUM_HISTORY_DATA=100,X.NUM_FRAMES_TO_AVERAGE=128,X.FPS_VALID_THRESHOLD=5;class j{static mulMatrixMatrix4(e,t,i){const r=t[0],s=t[1],o=t[2],a=t[3],n=t[4],h=t[5],u=t[6],f=t[7],l=t[8],c=t[9],d=t[10],p=t[11],m=t[12],_=t[13],g=t[14],S=t[15],x=i[0],b=i[1],B=i[2],A=i[3],P=i[4],D=i[5],y=i[6],M=i[7],E=i[8],v=i[9],U=i[10],G=i[11],L=i[12],T=i[13],F=i[14],w=i[15];e[0]=r*x+s*P+o*E+a*L,e[1]=r*b+s*D+o*v+a*T,e[2]=r*B+s*y+o*U+a*F,e[3]=r*A+s*M+o*G+a*w,e[4]=n*x+h*P+u*E+f*L,e[5]=n*b+h*D+u*v+f*T,e[6]=n*B+h*y+u*U+f*F,e[7]=n*A+h*M+u*G+f*w,e[8]=l*x+c*P+d*E+p*L,e[9]=l*b+c*D+d*v+p*T,e[10]=l*B+c*y+d*U+p*F,e[11]=l*A+c*M+d*G+p*w,e[12]=m*x+_*P+g*E+S*L,e[13]=m*b+_*D+g*v+S*T,e[14]=m*B+_*y+g*U+S*F,e[15]=m*A+_*M+g*G+S*w}static inverse4(e,t){const i=t[0],r=t[1],s=t[2],o=t[3],a=t[4],n=t[5],h=t[6],u=t[7],f=t[8],l=t[9],c=t[10],d=t[11],p=t[12],m=t[13],_=t[14],g=t[15],S=c*g,x=_*d,b=h*g,B=_*u,A=h*d,P=c*u,D=s*g,y=_*o,M=s*d,E=c*o,v=s*u,U=h*o,G=f*m,L=p*l,T=a*m,F=p*n,w=a*l,C=f*n,O=i*m,N=p*r,I=i*l,R=f*r,W=i*n,V=a*r,k=S*n+B*l+A*m-(x*n+b*l+P*m),z=x*r+D*l+E*m-(S*r+y*l+M*m),H=b*r+y*n+v*m-(B*r+D*n+U*m),Y=P*r+M*n+U*l-(A*r+E*n+v*l),q=1/(i*k+a*z+f*H+p*Y);e[0]=q*k,e[1]=q*z,e[2]=q*H,e[3]=q*Y,e[4]=q*(x*a+b*f+P*p-(S*a+B*f+A*p)),e[5]=q*(S*i+y*f+M*p-(x*i+D*f+E*p)),e[6]=q*(B*i+D*a+U*p-(b*i+y*a+v*p)),e[7]=q*(A*i+E*a+v*f-(P*i+M*a+U*f)),e[8]=q*(G*u+F*d+w*g-(L*u+T*d+C*g)),e[9]=q*(L*o+O*d+R*g-(G*o+N*d+I*g)),e[10]=q*(T*o+N*u+W*g-(F*o+O*u+V*g)),e[11]=q*(C*o+I*u+V*d-(w*o+R*u+W*d)),e[12]=q*(T*c+C*_+L*h-(w*_+G*h+F*c)),e[13]=q*(I*_+G*s+N*c-(O*c+R*_+L*s)),e[14]=q*(O*h+V*_+F*s-(W*_+T*s+N*h)),e[15]=q*(W*c+w*s+R*h-(I*h+V*c+C*s))}static transpose4(e,t){const i=t[0],r=t[1],s=t[2],o=t[3],a=t[4],n=t[5],h=t[6],u=t[7],f=t[8],l=t[9],c=t[10],d=t[11],p=t[12],m=t[13],_=t[14],g=t[15];e[0]=i,e[1]=a,e[2]=f,e[3]=p,e[4]=r,e[5]=n,e[6]=l,e[7]=m,e[8]=s,e[9]=h,e[10]=c,e[11]=_,e[12]=o,e[13]=u,e[14]=d,e[15]=g}static frustum(e,t,i,r,s,o,a){const n=i-t,h=s-r,u=o-a;e[0]=2*o/n,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*o/h,e[6]=0,e[7]=0,e[8]=(t+i)/n,e[9]=(s+r)/h,e[10]=a/u,e[11]=-1,e[12]=0,e[13]=0,e[14]=o*a/u,e[15]=0}static getAxis(e,t,i){const r=4*i;e[0]=t[r+0],e[1]=t[r+1],e[2]=t[r+2]}static mulScalarVector(e,t,i){for(let r=0;r<i;++r)t[r]=t[r]*e}static addVector(e,t,i,r){for(let s=0;s<r;++s)e[s]=t[s]+i[s]}static normalize(e,t,i){let r=0;for(let e=0;e<i;++e)r+=t[e]*t[e];if(r=Math.sqrt(r),r>1e-5)for(let s=0;s<i;++s)e[s]=t[s]/r;else for(let t=0;t<i;++t)e[t]=0}static subVector(e,t,i,r){for(let s=0;s<r;++s)e[s]=t[s]-i[s]}static cross(e,t,i){e[0]=t[1]*i[2]-t[2]*i[1],e[1]=t[2]*i[0]-t[0]*i[2],e[2]=t[0]*i[1]-t[1]*i[0]}static dot(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}static cameraLookAt(e,t,i,r){let s=new Float32Array(3),o=new Float32Array(3),a=new Float32Array(3);j.subVector(s,t,i,3),j.normalize(s,s,3),j.cross(o,r,s),j.normalize(o,o,3),j.cross(a,s,o),e[0]=o[0],e[1]=o[1],e[2]=o[2],e[3]=0,e[4]=a[0],e[5]=a[1],e[6]=a[2],e[7]=0,e[8]=s[0],e[9]=s[1],e[10]=s[2],e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1}static resetPseudoRandom(){j._randomSeed=0}static pseudoRandom(){return j._randomSeed=(134775813*j._randomSeed+1)%j._RANDOM_RANGE,j._randomSeed/j._randomSeed}static translation(e,t){e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1}static translate(e,t){const i=t[0],r=t[1],s=t[2],o=e[0],a=e[1],n=e[2],h=e[3],u=e[4],f=e[5],l=e[6],c=e[7],d=e[8],p=e[9],m=e[10],_=e[11],g=e[12],S=e[13],x=e[14],b=e[15];e[12]=o*i+u*r+d*s+g,e[13]=a*i+f*r+p*s+S,e[14]=n*i+l*r+m*s+x,e[15]=h*i+c*r+_*s+b}static degToRad(e){return e*Math.PI/180}}j._RANDOM_RANGE=4294967296,j._randomSeed=0;var K,J,Q,Z,$=function(e,t,i,r){return new(i||(i=Promise))((function(s,o){function a(e){try{h(r.next(e))}catch(e){o(e)}}function n(e){try{h(r.throw(e))}catch(e){o(e)}}function h(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,n)}h((r=r.apply(e,t||[])).next())}))};!function(e){e[e.MODELFIRST=0]="MODELFIRST",e[e.MODELRUINCOlOMN=1]="MODELRUINCOlOMN",e[e.MODELARCH=2]="MODELARCH",e[e.MODELROCKA=3]="MODELROCKA",e[e.MODELROCKB=4]="MODELROCKB",e[e.MODELROCKC=5]="MODELROCKC",e[e.MODELSUNKNSHIPBOXES=6]="MODELSUNKNSHIPBOXES",e[e.MODELSUNKNSHIPDECK=7]="MODELSUNKNSHIPDECK",e[e.MODELSUNKNSHIPHULL=8]="MODELSUNKNSHIPHULL",e[e.MODELFLOORBASE_BAKED=9]="MODELFLOORBASE_BAKED",e[e.MODELSUNKNSUB=10]="MODELSUNKNSUB",e[e.MODELCORAL=11]="MODELCORAL",e[e.MODELSTONE=12]="MODELSTONE",e[e.MODELCORALSTONEA=13]="MODELCORALSTONEA",e[e.MODELCORALSTONEB=14]="MODELCORALSTONEB",e[e.MODELGLOBEBASE=15]="MODELGLOBEBASE",e[e.MODELTREASURECHEST=16]="MODELTREASURECHEST",e[e.MODELENVIRONMENTBOX=17]="MODELENVIRONMENTBOX",e[e.MODELSUPPORTBEAMS=18]="MODELSUPPORTBEAMS",e[e.MODELSKYBOX=19]="MODELSKYBOX",e[e.MODELGLOBEINNER=20]="MODELGLOBEINNER",e[e.MODELSEAWEEDA=21]="MODELSEAWEEDA",e[e.MODELSEAWEEDB=22]="MODELSEAWEEDB",e[e.MODELSMALLFISHA=23]="MODELSMALLFISHA",e[e.MODELMEDIUMFISHA=24]="MODELMEDIUMFISHA",e[e.MODELMEDIUMFISHB=25]="MODELMEDIUMFISHB",e[e.MODELBIGFISHA=26]="MODELBIGFISHA",e[e.MODELBIGFISHB=27]="MODELBIGFISHB",e[e.MODELSMALLFISHAINSTANCEDDRAWS=28]="MODELSMALLFISHAINSTANCEDDRAWS",e[e.MODELMEDIUMFISHAINSTANCEDDRAWS=29]="MODELMEDIUMFISHAINSTANCEDDRAWS",e[e.MODELMEDIUMFISHBINSTANCEDDRAWS=30]="MODELMEDIUMFISHBINSTANCEDDRAWS",e[e.MODELBIGFISHAINSTANCEDDRAWS=31]="MODELBIGFISHAINSTANCEDDRAWS",e[e.MODELBIGFISHBINSTANCEDDRAWS=32]="MODELBIGFISHBINSTANCEDDRAWS",e[e.MODELMAX=33]="MODELMAX"}(K||(K={})),function(e){e[e.FISH=0]="FISH",e[e.FISHINSTANCEDDRAW=1]="FISHINSTANCEDDRAW",e[e.INNER=2]="INNER",e[e.SEAWEED=3]="SEAWEED",e[e.GENERIC=4]="GENERIC",e[e.OUTSIDE=5]="OUTSIDE",e[e.GROUPMAX=6]="GROUPMAX"}(J||(J={}));!function(e){e[e.BIG=0]="BIG",e[e.MEDIUM=1]="MEDIUM",e[e.SMALL=2]="SMALL",e[e.MAX=3]="MAX"}(Q||(Q={})),function(e){e[e.AUTOSTOP=0]="AUTOSTOP",e[e.ENABLEALPHABLENDING=1]="ENABLEALPHABLENDING",e[e.ENABLEMSAAx4=2]="ENABLEMSAAx4",e[e.ENABLEINSTANCEDDRAWS=3]="ENABLEINSTANCEDDRAWS",e[e.ENABLEDYNAMICBUFFEROFFSET=4]="ENABLEDYNAMICBUFFEROFFSET",e[e.DISABLED3D12RENDERPASS=5]="DISABLED3D12RENDERPASS",e[e.DISABLEWEBGPUVALIDATION=6]="DISABLEWEBGPUVALIDATION",e[e.DISABLECONTROLPANEL=7]="DISABLECONTROLPANEL",e[e.INTEGRATEDGPU=8]="INTEGRATEDGPU",e[e.DISCRETEGPU=9]="DISCRETEGPU",e[e.UPATEANDDRAWFOREACHMODEL=10]="UPATEANDDRAWFOREACHMODEL",e[e.ENABLEFULLSCREENMODE=11]="ENABLEFULLSCREENMODE",e[e.PRINTLOG=12]="PRINTLOG",e[e.BUFFERMAPPINGASYNC=13]="BUFFERMAPPINGASYNC",e[e.SIMULATINGFISHCOMEANDGO=14]="SIMULATINGFISHCOMEANDGO",e[e.TURNOFFVSYNC=15]="TURNOFFVSYNC",e[e.TOGGLEMAX=16]="TOGGLEMAX"}(Z||(Z={}));const ee=[{namestr:"SmallFishA",name:K.MODELSMALLFISHA,program:["fishVertexShader","fishReflectionFragmentShader"],fog:!0,type:J.FISH},{namestr:"MediumFishA",name:K.MODELMEDIUMFISHA,program:["fishVertexShader","fishNormalMapFragmentShader"],fog:!0,type:J.FISH},{namestr:"MediumFishB",name:K.MODELMEDIUMFISHB,program:["fishVertexShader","fishReflectionFragmentShader"],fog:!0,type:J.FISH},{namestr:"BigFishA",name:K.MODELBIGFISHA,program:["fishVertexShader","fishNormalMapFragmentShader"],fog:!0,type:J.FISH},{namestr:"BigFishB",name:K.MODELBIGFISHB,program:["fishVertexShader","fishNormalMapFragmentShader"],fog:!0,type:J.FISH},{namestr:"SmallFishA",name:K.MODELSMALLFISHAINSTANCEDDRAWS,program:["fishVertexShaderInstancedDraws","fishReflectionFragmentShader"],fog:!0,type:J.FISHINSTANCEDDRAW},{namestr:"MediumFishA",name:K.MODELMEDIUMFISHAINSTANCEDDRAWS,program:["fishVertexShaderInstancedDraws","fishNormalMapFragmentShader"],fog:!0,type:J.FISHINSTANCEDDRAW},{namestr:"MediumFishB",name:K.MODELMEDIUMFISHBINSTANCEDDRAWS,program:["fishVertexShaderInstancedDraws","fishReflectionFragmentShader"],fog:!0,type:J.FISHINSTANCEDDRAW},{namestr:"BigFishA",name:K.MODELBIGFISHAINSTANCEDDRAWS,program:["fishVertexShaderInstancedDraws","fishNormalMapFragmentShader"],fog:!0,type:J.FISHINSTANCEDDRAW},{namestr:"BigFishB",name:K.MODELBIGFISHBINSTANCEDDRAWS,program:["fishVertexShaderInstancedDraws","fishNormalMapFragmentShader"],fog:!0,type:J.FISHINSTANCEDDRAW},{namestr:"Arch",name:K.MODELARCH,program:["",""],fog:!0,type:J.GENERIC},{namestr:"Coral",name:K.MODELCORAL,program:["",""],fog:!0,type:J.GENERIC},{namestr:"CoralStoneA",name:K.MODELCORALSTONEA,program:["",""],fog:!0,type:J.GENERIC},{namestr:"CoralStoneB",name:K.MODELCORALSTONEB,program:["",""],fog:!0,type:J.GENERIC},{namestr:"EnvironmentBox",name:K.MODELENVIRONMENTBOX,program:["diffuseVertexShader","diffuseFragmentShader"],fog:!1,type:J.OUTSIDE},{namestr:"FloorBase_Baked",name:K.MODELFLOORBASE_BAKED,program:["",""],fog:!0,type:J.GENERIC},{namestr:"GlobeBase",name:K.MODELGLOBEBASE,program:["diffuseVertexShader","diffuseFragmentShader"],fog:!1,type:J.GENERIC},{namestr:"RockA",name:K.MODELROCKA,program:["",""],fog:!0,type:J.GENERIC},{namestr:"RockB",name:K.MODELROCKB,program:["",""],fog:!0,type:J.GENERIC},{namestr:"RockC",name:K.MODELROCKC,program:["",""],fog:!0,type:J.GENERIC},{namestr:"RuinColumn",name:K.MODELRUINCOlOMN,program:["",""],fog:!0,type:J.GENERIC},{namestr:"Stone",name:K.MODELSTONE,program:["",""],fog:!0,type:J.GENERIC},{namestr:"SunknShipBoxes",name:K.MODELSUNKNSHIPBOXES,program:["",""],fog:!0,type:J.GENERIC},{namestr:"SunknShipDeck",name:K.MODELSUNKNSHIPDECK,program:["",""],fog:!0,type:J.GENERIC},{namestr:"SunknShipHull",name:K.MODELSUNKNSHIPHULL,program:["",""],fog:!0,type:J.GENERIC},{namestr:"SunknSub",name:K.MODELSUNKNSUB,program:["",""],fog:!0,type:J.GENERIC},{namestr:"SeaweedA",name:K.MODELSEAWEEDA,program:["seaweedVertexShader","seaweedFragmentShader"],fog:!1,type:J.SEAWEED},{namestr:"SeaweedB",name:K.MODELSEAWEEDB,program:["seaweedVertexShader","seaweedFragmentShader"],fog:!1,type:J.SEAWEED},{namestr:"Skybox",name:K.MODELSKYBOX,program:["diffuseVertexShader","diffuseFragmentShader"],fog:!1,type:J.OUTSIDE},{namestr:"SupportBeams",name:K.MODELSUPPORTBEAMS,program:["",""],fog:!1,type:J.OUTSIDE},{namestr:"TreasureChest",name:K.MODELTREASURECHEST,program:["",""],fog:!0,type:J.GENERIC}],te=[{name:"SmallFishA",modelName:K.MODELSMALLFISHA,type:Q.SMALL,speed:1,speedRange:1.5,radius:30,radiusRange:25,tailSpeed:10,heightOffset:0,heightRange:16,fishLength:10,fishWaveLength:1,fishBendAmount:2},{name:"MediumFishA",modelName:K.MODELMEDIUMFISHA,type:Q.MEDIUM,speed:1,speedRange:2,radius:10,radiusRange:20,tailSpeed:1,heightOffset:0,heightRange:16,fishLength:10,fishWaveLength:-2,fishBendAmount:2},{name:"MediumFishB",modelName:K.MODELMEDIUMFISHB,type:Q.MEDIUM,speed:.5,speedRange:4,radius:10,radiusRange:20,tailSpeed:3,heightOffset:-8,heightRange:5,fishLength:10,fishWaveLength:-2,fishBendAmount:2},{name:"BigFishA",modelName:K.MODELBIGFISHA,type:Q.BIG,speed:.5,speedRange:.5,radius:50,radiusRange:3,tailSpeed:1.5,heightOffset:0,heightRange:16,fishLength:10,fishWaveLength:-1,fishBendAmount:.5,lasers:!0,laserRot:.04,laserOff:[0,.1,9],laserScale:[.3,.3,1e3]},{name:"BigFishB",modelName:K.MODELBIGFISHB,type:Q.BIG,speed:.5,speedRange:.5,radius:45,radiusRange:3,tailSpeed:1,heightOffset:0,heightRange:16,fishLength:10,fishWaveLength:-.7,fishBendAmount:.3,lasers:!0,laserRot:.04,laserOff:[0,-.3,9],laserScale:[.3,.3,1e3]}],ie=(Math.PI,Math.PI,[0,0,0]);class re{constructor(){this.projection=r(16,()=>0),this.view=r(16,()=>0),this.worldInverse=r(16,()=>0),this.viewProjectionInverse=r(16,()=>0),this.skyView=r(16,()=>0),this.skyViewProjection=r(16,()=>0),this.skyViewProjectionInverse=r(16,()=>0),this.eyePosition=r(3,()=>0),this.target=r(3,()=>0),this.up=[0,1,0],this.v3t0=r(3,()=>0),this.v3t1=r(3,()=>0),this.m4t0=r(16,()=>0),this.m4t1=r(16,()=>0),this.m4t2=r(16,()=>0),this.m4t3=r(16,()=>0),this.colorMult=[1,1,1,1]}}class se{constructor(){this.lightWorldPositionUniform=new x,this.worldUniforms=new B,this.lightUniforms=new S,this.fogUniforms=new m,this.g=new re,this._modelEnumMap={},this._textureMap={},this._programMap={},this._context=null,this._fpsTimer=null,this._curFishCount=1,this._preFishCount=0,this.g.then=0,this.g.mclock=0,this.g.eyeClock=0,this.g.alpha="1",this.lightUniforms.ambient=[.218,.502,.706,0],this.lightUniforms.lightColor=[1,1,1,1],this.lightUniforms.specular=[1,1,1,1],this.fogUniforms.fogColor=[.338,.81,1,1],this.fogUniforms.fogPower=16.5,this.fogUniforms.fogMult=1.5,this.fogUniforms.fogOffset=.738,this.fishCount=[0,0,0,0,0],this.toggleBitset=r(Z.TOGGLEMAX,()=>!1),this._aquariumModels=r(K.MODELMAX,()=>null),this._fpsTimer=new X}dispose(){}get skybox(){return this._textureMap.skybox}get curFishCount(){return this._curFishCount}get preFishCount(){return this._preFishCount}init(e){return $(this,void 0,void 0,(function*(){return Promise.resolve().then(()=>$(this,void 0,void 0,(function*(){this._context=new q;const t=this._context.availableToggleBitset;if(t[Z.UPATEANDDRAWFOREACHMODEL]&&(this.toggleBitset[Z.UPATEANDDRAWFOREACHMODEL]=!0),t[Z.ENABLEDYNAMICBUFFEROFFSET]&&(this.toggleBitset[Z.ENABLEDYNAMICBUFFEROFFSET]=!0),this.toggleBitset[Z.ENABLEALPHABLENDING]=!0,!this._processOptions(e,t))return!1;if(!(yield this._context.initialize(this.toggleBitset,e.canvas)))return!1;this._calculateFishCount(),console.log("Init resources ..."),this._getElapsedTime();const i=this._context.resourceHelper.getSkyBoxUrls();return this._textureMap.skybox=yield this._context.createTextureWebGPU("skybox",i),this._context.initGeneralResources(this),this._preFishCount=this._curFishCount,this._setupModelEnumMap(),yield this.loadResource(),this._context.flush(),console.log("End loading.\nCost "+this._getElapsedTime()+"s totally."),this._resetFpsTime(),!0})))}))}_processOptions(e,t){if(!e)return!1;if(e.num_fish&&(this._curFishCount=e.num_fish,this._curFishCount<0))return console.error("Fish count should larger or equal to 0."),!1;if(e.enable_msaa){if(!t[Z.ENABLEMSAAx4])return console.error("MSAA isn't implemented for the backend."),!1;this.toggleBitset[Z.ENABLEMSAAx4]=!0}if(e.disable_dynamic_buffer_offset){if(!t[Z.ENABLEDYNAMICBUFFEROFFSET])return console.error("Dynamic buffer offset is not supported."),!1;this.toggleBitset[Z.ENABLEDYNAMICBUFFEROFFSET]=!0}if(e.integrated_gpu){if(!t[Z.INTEGRATEDGPU]&&!t[Z.DISCRETEGPU])return console.error("Dynamically choose gpu isn't supported for the backend."),!1;t[Z.DISCRETEGPU]&&console.error("Integrated and Discrete gpu cannot be used simultaneosly."),this.toggleBitset[Z.INTEGRATEDGPU]=!0}if(e.discrete_gpu){if(!t[Z.INTEGRATEDGPU]&&!t[Z.DISCRETEGPU])return console.error("Dynamically choose gpu isn't supported for the backend."),!1;t[Z.INTEGRATEDGPU]&&console.error("Integrated and Discrete gpu cannot be used simultaneosly."),this.toggleBitset[Z.DISCRETEGPU]=!0}if(e.enable_full_screen_mode){if(!t[Z.ENABLEFULLSCREENMODE])return console.error("Full screen mode isn't supported for the backend."),!1;this.toggleBitset[Z.ENABLEFULLSCREENMODE]=!0}if(e.print_log&&(this.toggleBitset[Z.PRINTLOG]=!0),e.buffer_mapping_async){if(!t[Z.BUFFERMAPPINGASYNC])return console.error("Buffer mapping async isn't supported for the backend."),!1;this.toggleBitset[Z.BUFFERMAPPINGASYNC]=!0}if(e.turn_off_vsync){if(!t[Z.TURNOFFVSYNC])return console.error("Turn off vsync isn't supported for the backend."),!1;this.toggleBitset[Z.TURNOFFVSYNC]=!0}if(e.test_time&&(this._testTime=e.test_time,this.toggleBitset[Z.AUTOSTOP]=!0),e.disable_webgpu_validation){if(!t[Z.DISABLEWEBGPUVALIDATION])return console.error("Disable validation for WebGPU backend."),!1;this.toggleBitset[Z.DISABLEWEBGPUVALIDATION]=!0}if(e.enable_alpha_blending&&(this.g.alpha=e.enable_alpha_blending,"false"===this.g.alpha&&(this.toggleBitset[Z.ENABLEALPHABLENDING]=!1)),e.simulating_fish_come_and_go){if(!t[Z.SIMULATINGFISHCOMEANDGO])return console.error("Simulating fish come and go is only implemented for WebGPU backend."),!1;this.toggleBitset[Z.SIMULATINGFISHCOMEANDGO]=!0}return e.disable_control_panel&&(this.toggleBitset[Z.DISABLECONTROLPANEL]=!0),!0}_resetFpsTime(){this.g.start=performance.now()/1e3,this.g.then=this.g.start}display(){let e=this._context.shouldQuit();e||(this._context.keyBoardQuit(),this._render(),this._context.doFlush(this.toggleBitset),this.toggleBitset[Z.AUTOSTOP]&&this.g.then-this.g.start>this._testTime&&(e=!0)),e?(this._context.terminate(),this.toggleBitset[Z.PRINTLOG]&&this._printAvgFps()):window.requestAnimationFrame(this.display.bind(this))}loadResource(){return $(this,void 0,void 0,(function*(){return Promise.resolve().then(()=>$(this,void 0,void 0,(function*(){yield this._loadModels(),yield this._loadPlacement(),this.toggleBitset[Z.SIMULATINGFISHCOMEANDGO]&&(yield this._loadFishScenario())})))}))}_setupModelEnumMap(){for(let e of ee)this._modelEnumMap[e.namestr]=e.name}_loadPlacement(){return $(this,void 0,void 0,(function*(){const e=this._context.resourceHelper.propPlacementPath;return new Promise((t,i)=>{C.LoadJSON(e,(e,r)=>{r&&(console.error("Unable to load placement file: "+r),i(r)),s("objects"in e,"JSON file does not contain an 'objects' key.");let o=e.objects;s(Array.isArray(o),"'objects' value is not an array.");for(let e=0;e<o.length;++e){const t=o[e].name,i=o[e].worldMatrix;s(Array.isArray(i)&&16==i.length,"Invalid world matrix");let r=[];for(let e=0;e<i.length;++e)r.push(i[e]);const a=this._modelEnumMap[t];a!==K.MODELFIRST&&this._aquariumModels[a]&&this._aquariumModels[a].worldmatrices.push(r)}t()})})}))}_loadModels(){return $(this,void 0,void 0,(function*(){return Promise.resolve().then(()=>$(this,void 0,void 0,(function*(){const e=this.toggleBitset[Z.ENABLEINSTANCEDDRAWS];for(let t of ee)e&&t.type===J.FISH||!e&&t.type===J.FISHINSTANCEDDRAW||(yield this._loadModel(t))})))}))}_loadFishScenario(){return $(this,void 0,void 0,(function*(){const e=this._context.resourceHelper.fishBehaviorPath;return new Promise((t,i)=>{C.LoadJSON(e,(e,r)=>{r&&(console.error("Unable to load fish scenario file: "+r),i(r)),s("behaviors"in e,"JSON file does not contain a 'behaviors' key.");let a=e.behaviors;s(Array.isArray(a),"'behaviors' value is not an array.");for(let e=0;e<a.length;++e){const t=a[e].frame,i=a[e].op,r=a[e].count,s=new o(t,i,r);this._fishBehavior.push(s)}t()})})}))}_loadModel(e){return $(this,void 0,void 0,(function*(){const t=this._context.resourceHelper,i=t.imagePath,r=t.programPath,o=t.getModelPath(e.namestr);return new Promise((t,a)=>$(this,void 0,void 0,(function*(){C.LoadJSON(o,(o,n)=>$(this,void 0,void 0,(function*(){n&&(console.error("Unable to load model file: "+n),a(n)),s("models"in o,"JSON file does not contain a 'models' key.");let h=o.models;s(Array.isArray(h),"'models' value is not an array.");let u=null;u=this.toggleBitset[Z.ENABLEALPHABLENDING]&&e.type!==J.INNER&&e.type!==J.OUTSIDE?this._context.createModel(this,e.type,e.name,!0):this._context.createModel(this,e.type,e.name,e.blend),this._aquariumModels[e.name]=u;let f=h[h.length-1];{const t=f.textures;for(let e in t){const r=e,s=t[e];s in this._textureMap||(this._textureMap[s]=yield this._context.createTextureWebGPU(r,i+s)),u.textureMap[r]=this._textureMap[s]}const o=f.fields;for(let e in o){const t=o[e],i=e,r=t.numComponents,a=t.type;let n=null;if("indices"==i){s("Uint16Array"===a,"Invalid indices array type.");let e=[];for(let i of t.data)e.push(i);n=this._context.createBufferWebGPU(r,new Uint16Array(e),!0)}else{s("Float32Array"===a,"Invalid vertices array type.");let e=[];for(let i of t.data)e.push(i);n=this._context.createBufferWebGPU(r,new Float32Array(e),!1)}u.bufferMap[i]=n}let a=e.program[0],n=e.program[1];""!==a&&""!==n?u.textureMap.skybox=this._textureMap.skybox:"reflection"in u.textureMap&&null!==u.textureMap.reflection?(a="reflectionMapVertexShader",n="reflectionMapFragmentShader",u.textureMap.skybox=this._textureMap.skybox):"normalMap"in u.textureMap&&null!==u.textureMap.normalMap?(a="normalMapVertexShader",n="normalMapFragmentShader"):(a="diffuseVertexShader",n="diffuseFragmentShader");let h=null;const l=a+n;l in this._programMap?h=this._programMap[l]:(h=this._context.createProgram(r+a,r+n),this.toggleBitset[Z.ENABLEALPHABLENDING]&&e.type!==J.INNER&&e.type!==J.OUTSIDE?yield h.compileProgram(!0,this.g.alpha):yield h.compileProgram(!1,this.g.alpha),this._programMap[l]=h),u.program=h,u.init()}t()})))})))}))}_calculateFishCount(){let e=this._curFishCount;for(let t=0;t<Q.MAX;++t)for(let i=0;i<te.length;++i){const r=te[i];if(r.type!=t)continue;let s=e;if(t==Q.BIG){let t=this._curFishCount<100?1:2;s=Math.min(e,t)}else t===Q.MEDIUM&&(s=this._curFishCount<1e3?Math.min(e,this._curFishCount/10):this._curFishCount<1e4?Math.min(e,80):Math.min(e,160));e-=s,this.fishCount[r.modelName-K.MODELSMALLFISHA]=s}}_getElapsedTime(){const e=performance.now()/1e3;let t=0;return t=0==this.g.then?0:e-this.g.then,this.g.then=e,t}_printAvgFps(){const e=this._fpsTimer.variance();console.log("Avg FPS: "+e),0==e&&console.log("Invalid value. The fps is unstable.")}_updateGlobalUniforms(){let e=this.g,t=this.lightWorldPositionUniform,i=this._getElapsedTime(),r=e.then-e.start;this._fpsTimer.update(i,r,this._testTime),e.mclock+=1*i,e.eyeClock+=.0258*i,e.eyePosition[0]=13.2*Math.sin(e.eyeClock),e.eyePosition[1]=7.5,e.eyePosition[2]=13.2*Math.cos(e.eyeClock),e.target[0]=91.6*Math.sin(e.eyeClock+Math.PI),e.target[1]=63.3,e.target[2]=91.6*Math.cos(e.eyeClock+Math.PI);let s=1*this._context.clientWidth/(1*this._context.clientHeight),o=1*Math.tan(.5*j.degToRad(82.699)),a=-o,n=s*a,h=s*o,u=Math.abs(h-n),f=Math.abs(o-a),l=u*ie[0]*1.21,c=f*ie[1]*1.21;j.frustum(e.projection,n+l,h+l,a+c,o+c,1,25e3),j.cameraLookAt(t.viewInverse,e.eyePosition,e.target,e.up),j.inverse4(e.view,t.viewInverse),j.mulMatrixMatrix4(t.viewProjection,e.view,e.projection),j.inverse4(e.viewProjectionInverse,t.viewProjection),e.skyView[12]=0,e.skyView[13]=0,e.skyView[14]=0,j.mulMatrixMatrix4(e.skyViewProjection,e.skyView,e.projection),j.inverse4(e.skyViewProjectionInverse,e.skyViewProjection),j.getAxis(e.v3t0,t.viewInverse,0),j.getAxis(e.v3t1,t.viewInverse,1),j.mulScalarVector(20,e.v3t0,3),j.mulScalarVector(30,e.v3t1,3),j.addVector(t.lightWorldPos,e.eyePosition,e.v3t0,3),j.addVector(t.lightWorldPos,t.lightWorldPos,e.v3t1,3),this._context.updateWorldlUniforms(this)}_render(){if(j.resetPseudoRandom(),this._context.preFrame(),this._updateGlobalUniforms(),this.toggleBitset[Z.SIMULATINGFISHCOMEANDGO]&&this._fishBehavior.length>0){const e=this._fishBehavior[0];let t=e.frame;0==t?(this._fishBehavior.shift(),"+"===e.op?this._curFishCount+=e.count:this._curFishCount-=e.count,console.log("Fish count "+this._curFishCount)):e.frame=--t}if(!this.toggleBitset[Z.ENABLEINSTANCEDDRAWS]&&this.curFishCount!=this.preFishCount){this._calculateFishCount();const e=this.toggleBitset[Z.ENABLEDYNAMICBUFFEROFFSET];this._context.reallocResource(this.preFishCount,this.curFishCount,e),this._preFishCount=this.curFishCount,this._resetFpsTime()}this.toggleBitset[Z.UPATEANDDRAWFOREACHMODEL]?(this._updateAndDrawBackground(),this._updateAndDrawFishes(),this._context.updateFPS(this._fpsTimer,this.curFishCount,this.toggleBitset)):(this._updateBackground(),this._updateFishes(),this._context.updateFPS(this._fpsTimer,this.curFishCount,this.toggleBitset),this._context.beginRenderPass(),this._drawBackground(),this._drawFishes(),this._context.showFPS())}_updateAndDrawBackground(){for(let e=K.MODELRUINCOlOMN;e<=K.MODELSEAWEEDB;++e){const t=this._aquariumModels[e];t&&this._updateWorldMatrixAndDraw(t)}}_drawBackground(){for(let e=K.MODELRUINCOlOMN;e<=K.MODELSEAWEEDB;++e){const t=this._aquariumModels[e];t&&t.draw()}}_updateAndDrawFishes(){const e=this.toggleBitset[Z.ENABLEINSTANCEDDRAWS]?K.MODELSMALLFISHAINSTANCEDDRAWS:K.MODELSMALLFISHA,t=this.toggleBitset[Z.ENABLEINSTANCEDDRAWS]?K.MODELBIGFISHBINSTANCEDDRAWS:K.MODELBIGFISHB;for(let i=e;i<=t;++i){const t=this._aquariumModels[i];if(!t)continue;const r=te[i-e],s=this.fishCount[i-e];t.prepareForDraw();const o=.124*this.g.mclock,a=r.radius,n=r.radiusRange,h=r.speed,u=r.speedRange,f=1*r.tailSpeed,l=.52,c=25+r.heightOffset,d=1*r.heightRange,p=1,m=.556,_=1;for(let e=0;e<s;++e){const i=o+e*l,r=h+1*j.pseudoRandom()*u,s=1+1*j.pseudoRandom(),g=a+1*j.pseudoRandom()*n,S=2+1*j.pseudoRandom()*d,x=a+1*j.pseudoRandom()*n,b=i*r,B=b*p,A=b*m,P=b*_;t.updateFishPerUniforms(Math.sin(B)*g,Math.sin(A)*S+c,Math.cos(P)*x,Math.sin(B-.04)*g,Math.sin(A-.01)*S+c,Math.cos(P-.04)*x,s,(this.g.mclock+1*e)*f*r%(2*Math.PI),e),t.updatePerInstanceUniforms(this.worldUniforms),t.draw()}}}_updateBackground(){for(let e=K.MODELRUINCOlOMN;e<=K.MODELSEAWEEDB;++e){const t=this._aquariumModels[e];t&&this._updateWorldMatrix(t)}}_updateFishes(){const e=this.toggleBitset[Z.ENABLEINSTANCEDDRAWS]?K.MODELSMALLFISHAINSTANCEDDRAWS:K.MODELSMALLFISHA,t=this.toggleBitset[Z.ENABLEINSTANCEDDRAWS]?K.MODELBIGFISHBINSTANCEDDRAWS:K.MODELBIGFISHB;for(let i=e;i<=t;++i){const t=this._aquariumModels[i];if(!t)continue;const r=te[i-e],s=this.fishCount[i-e];t.prepareForDraw();const o=.124*this.g.mclock,a=r.radius,n=r.radiusRange,h=r.speed,u=r.speedRange,f=1*r.tailSpeed,l=.52,c=25+r.heightOffset,d=1*r.heightRange,p=1,m=.556,_=1;for(let e=0;e<s;++e){const i=o+e*l,r=h+1*j.pseudoRandom()*u,s=1+1*j.pseudoRandom(),g=a+1*j.pseudoRandom()*n,S=2+1*j.pseudoRandom()*d,x=a+1*j.pseudoRandom()*n,b=i*r,B=b*p,A=b*m,P=b*_;t.updateFishPerUniforms(Math.sin(B)*g,Math.sin(A)*S+c,Math.cos(P)*x,Math.sin(B-.04)*g,Math.sin(A-.01)*S+c,Math.cos(P-.04)*x,s,(this.g.mclock+1*e)*f*r%(2*Math.PI),e)}}this._context.updateAllFishData()}_drawFishes(){const e=this.toggleBitset[Z.ENABLEINSTANCEDDRAWS]?K.MODELSMALLFISHAINSTANCEDDRAWS:K.MODELSMALLFISHA,t=this.toggleBitset[Z.ENABLEINSTANCEDDRAWS]?K.MODELBIGFISHBINSTANCEDDRAWS:K.MODELBIGFISHB;for(let i=e;i<=t;++i){const e=this._aquariumModels[i];e&&e.draw()}}_updateWorldProjections(e){s(16===e.length,"The length of the array should be equal to 16.");for(let t=0;t<16;++t)this.worldUniforms.world[t]=e[t];j.mulMatrixMatrix4(this.worldUniforms.worldViewProjection,this.worldUniforms.world,this.lightWorldPositionUniform.viewProjection),j.inverse4(this.g.worldInverse,this.worldUniforms.world),j.transpose4(this.worldUniforms.worldInverseTranspose,this.g.worldInverse)}_updateWorldMatrixAndDraw(e){if(e.worldmatrices.length>0)for(let t of e.worldmatrices)this._updateWorldProjections(t),e.prepareForDraw(),e.updatePerInstanceUniforms(this.worldUniforms),e.draw()}_updateWorldMatrix(e){if(e.worldmatrices.length>0)for(let t of e.worldmatrices)this._updateWorldProjections(t),e.updatePerInstanceUniforms(this.worldUniforms);e.prepareForDraw()}}var oe=function(e,t,i,r){return new(i||(i=Promise))((function(s,o){function a(e){try{h(r.next(e))}catch(e){o(e)}}function n(e){try{h(r.throw(e))}catch(e){o(e)}}function h(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,n)}h((r=r.apply(e,t||[])).next())}))};!function(){oe(this,void 0,void 0,(function*(){const e=document.getElementById("gfx"),t=new se,i={canvas:e,enable_full_screen_mode:!0,num_fish:100};t.init(i).then(e=>{e?t.display():console.error("Unable to initialize aquarium!")}).catch(e=>{console.error(e)})}))}()}]);
//# sourceMappingURL=main.js.map